<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>维格表数据结构调试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        .result {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { border-left: 4px solid #28a745; }
        .error { border-left: 4px solid #dc3545; }
        .info { border-left: 4px solid #17a2b8; }
        .warning { border-left: 4px solid #ffc107; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .config-section {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>维格表数据结构调试工具</h1>
        
        <div class="config-section">
            <h3>当前配置</h3>
            <div id="currentConfig"></div>
        </div>

        <div class="section">
            <h3>1. 测试连接</h3>
            <button onclick="testConnection()">测试维格表连接</button>
            <div id="connectionResult" class="result"></div>
        </div>

        <div class="section">
            <h3>2. 获取原始数据</h3>
            <button onclick="getRawData()">获取所有记录（原始数据）</button>
            <div id="rawDataResult" class="result"></div>
        </div>

        <div class="section">
            <h3>3. 分析字段结构</h3>
            <button onclick="analyzeFields()">分析字段结构</button>
            <div id="fieldsResult" class="result"></div>
        </div>

        <div class="section">
            <h3>4. 测试不同字段映射</h3>
            <button onclick="testFieldMapping('name')">使用 fieldKey: "name"</button>
            <button onclick="testFieldMapping('id')">使用 fieldKey: "id"</button>
            <div id="mappingResult" class="result"></div>
        </div>

        <div class="section">
            <h3>5. 查找激活码字段</h3>
            <button onclick="findCodeField()">查找包含激活码的字段</button>
            <div id="codeFieldResult" class="result"></div>
        </div>
    </div>

    <script>
        // 维格表配置
        const VIKA_CONFIG = {
            token: "uskNUrvWvJoD3VuQ5zW7GYH",
            baseUrl: "https://api.vika.cn/fusion/v1/",
            datasheetId: "dstVZvdm5sqCs9NFY4",
            fieldKey: "name"
        };

        // 显示当前配置
        document.getElementById('currentConfig').innerHTML = `
            <strong>Token:</strong> ${VIKA_CONFIG.token}<br>
            <strong>Base URL:</strong> ${VIKA_CONFIG.baseUrl}<br>
            <strong>Datasheet ID:</strong> ${VIKA_CONFIG.datasheetId}<br>
            <strong>Field Key:</strong> ${VIKA_CONFIG.fieldKey}
        `;

        function addResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.innerHTML += `<div class="${type}">[${timestamp}] ${content}</div>`;
            element.scrollTop = element.scrollHeight;
        }

        async function makeVikaRequest(method, endpoint = '', data = null, params = null) {
            let url = `${VIKA_CONFIG.baseUrl}datasheets/${VIKA_CONFIG.datasheetId}/records`;
            
            if (endpoint) {
                url += `/${endpoint}`;
            }
            
            if (params) {
                const urlParams = new URLSearchParams(params);
                url += `?${urlParams}`;
            }

            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${VIKA_CONFIG.token}`
                }
            };

            if (data && (method === 'POST' || method === 'PATCH')) {
                options.body = JSON.stringify(data);
            }

            console.log(`API请求: ${method} ${url}`);
            
            const response = await fetch(url, options);
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(`API请求失败: ${response.status} - ${JSON.stringify(result)}`);
            }
            
            return result;
        }

        async function testConnection() {
            addResult('connectionResult', '开始测试连接...', 'info');
            
            try {
                const result = await makeVikaRequest('GET', '', null, { fieldKey: VIKA_CONFIG.fieldKey });
                addResult('connectionResult', `连接成功！\n响应: ${JSON.stringify(result, null, 2)}`, 'success');
            } catch (error) {
                addResult('connectionResult', `连接失败: ${error.message}`, 'error');
            }
        }

        async function getRawData() {
            addResult('rawDataResult', '获取原始数据...', 'info');
            
            try {
                const result = await makeVikaRequest('GET', '', null, { fieldKey: VIKA_CONFIG.fieldKey });
                addResult('rawDataResult', `原始数据:\n${JSON.stringify(result, null, 2)}`, 'success');
                
                if (result.data && result.data.records) {
                    addResult('rawDataResult', `记录数量: ${result.data.records.length}`, 'info');
                }
            } catch (error) {
                addResult('rawDataResult', `获取失败: ${error.message}`, 'error');
            }
        }

        async function analyzeFields() {
            addResult('fieldsResult', '分析字段结构...', 'info');
            
            try {
                const result = await makeVikaRequest('GET', '', null, { fieldKey: VIKA_CONFIG.fieldKey });
                
                if (result.data && result.data.records && result.data.records.length > 0) {
                    const firstRecord = result.data.records[0];
                    addResult('fieldsResult', `第一条记录结构:\n${JSON.stringify(firstRecord, null, 2)}`, 'success');
                    
                    if (firstRecord.fields) {
                        const fieldNames = Object.keys(firstRecord.fields);
                        addResult('fieldsResult', `字段列表: ${fieldNames.join(', ')}`, 'info');
                        
                        // 分析每个字段的值
                        fieldNames.forEach(fieldName => {
                            const value = firstRecord.fields[fieldName];
                            addResult('fieldsResult', `${fieldName}: ${JSON.stringify(value)} (类型: ${typeof value})`, 'info');
                        });
                    }
                } else {
                    addResult('fieldsResult', '没有找到记录', 'warning');
                }
            } catch (error) {
                addResult('fieldsResult', `分析失败: ${error.message}`, 'error');
            }
        }

        async function testFieldMapping(fieldKey) {
            addResult('mappingResult', `测试字段映射: ${fieldKey}`, 'info');
            
            try {
                const result = await makeVikaRequest('GET', '', null, { fieldKey: fieldKey });
                addResult('mappingResult', `使用 fieldKey="${fieldKey}" 的结果:\n${JSON.stringify(result, null, 2)}`, 'success');
            } catch (error) {
                addResult('mappingResult', `fieldKey="${fieldKey}" 测试失败: ${error.message}`, 'error');
            }
        }

        async function findCodeField() {
            addResult('codeFieldResult', '查找激活码字段...', 'info');
            
            try {
                const result = await makeVikaRequest('GET', '', null, { fieldKey: VIKA_CONFIG.fieldKey });
                
                if (result.data && result.data.records) {
                    const codePatterns = [
                        /^[A-Z0-9]{8,}$/,  // 大写字母和数字，8位以上
                        /^[a-z0-9]{8,}$/,  // 小写字母和数字，8位以上
                        /^[A-Za-z0-9]{8,}$/ // 混合大小写，8位以上
                    ];
                    
                    const potentialCodeFields = new Set();
                    
                    result.data.records.forEach((record, index) => {
                        if (record.fields) {
                            Object.entries(record.fields).forEach(([fieldName, value]) => {
                                if (typeof value === 'string') {
                                    codePatterns.forEach(pattern => {
                                        if (pattern.test(value)) {
                                            potentialCodeFields.add(fieldName);
                                            addResult('codeFieldResult', `记录${index + 1}: 字段"${fieldName}"包含疑似激活码: ${value}`, 'success');
                                        }
                                    });
                                }
                            });
                        }
                    });
                    
                    if (potentialCodeFields.size > 0) {
                        addResult('codeFieldResult', `可能的激活码字段: ${Array.from(potentialCodeFields).join(', ')}`, 'info');
                    } else {
                        addResult('codeFieldResult', '未找到疑似激活码的字段', 'warning');
                    }
                } else {
                    addResult('codeFieldResult', '没有找到记录', 'warning');
                }
            } catch (error) {
                addResult('codeFieldResult', `查找失败: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
