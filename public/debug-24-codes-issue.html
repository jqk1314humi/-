<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>调试24个激活码限制问题</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .debug-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { border-left: 4px solid #28a745; }
        .error { border-left: 4px solid #dc3545; }
        .info { border-left: 4px solid #17a2b8; }
        .warning { border-left: 4px solid #ffc107; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .step {
            background: #e9ecef;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>调试24个激活码限制问题</h1>
        
        <div class="debug-section">
            <h3>问题分析步骤</h3>
            <div class="step">
                <strong>问题</strong>：从维格表云端只能读取24个激活码，而不是全部<br>
                <strong>可能原因</strong>：
                <ul>
                    <li>维格表API实际返回的记录数限制</li>
                    <li>激活码正则表达式过于严格，过滤掉了一些有效的激活码</li>
                    <li>字段名不匹配，部分记录没有被识别</li>
                    <li>分页逻辑有问题</li>
                </ul>
            </div>
        </div>

        <div class="debug-section">
            <h3>1. 检查API原始响应</h3>
            <button onclick="checkRawAPIResponse()">获取原始API响应</button>
            <div id="rawApiResult" class="result"></div>
        </div>

        <div class="debug-section">
            <h3>2. 分析记录总数vs激活码数量</h3>
            <button onclick="analyzeRecordCount()">分析记录数量差异</button>
            <div id="recordAnalysisResult" class="result"></div>
        </div>

        <div class="debug-section">
            <h3>3. 测试不同的激活码正则表达式</h3>
            <button onclick="testDifferentRegex()">测试宽松的正则表达式</button>
            <div id="regexTestResult" class="result"></div>
        </div>

        <div class="debug-section">
            <h3>4. 检查所有字段内容</h3>
            <button onclick="checkAllFieldContents()">检查所有字段的内容</button>
            <div id="fieldContentResult" class="result"></div>
        </div>

        <div class="debug-section">
            <h3>5. 测试不同的fieldKey设置</h3>
            <button onclick="testFieldKeySettings()">测试fieldKey参数</button>
            <div id="fieldKeyResult" class="result"></div>
        </div>

        <div class="debug-section">
            <h3>6. 测试分页逻辑</h3>
            <button onclick="testPaginationLogic()">测试分页是否正常</button>
            <div id="paginationResult" class="result"></div>
        </div>
    </div>

    <script src="cloud-storage-vika-v2.js"></script>
    <script>
        let vikaStorage = null;

        function addResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            element.innerHTML += `<div class="${type}">[${timestamp}] ${content}</div>`;
            element.scrollTop = element.scrollHeight;
        }

        // 初始化维格表存储
        document.addEventListener('DOMContentLoaded', () => {
            addResult('rawApiResult', '初始化维格表存储...', 'info');
            
            try {
                vikaStorage = new VikaCloudStorage();
                
                window.addEventListener('vikaStorageReady', (event) => {
                    addResult('rawApiResult', '维格表存储已就绪，可以开始调试', 'success');
                });
                
            } catch (error) {
                addResult('rawApiResult', `初始化失败: ${error.message}`, 'error');
            }
        });

        // 1. 检查API原始响应
        async function checkRawAPIResponse() {
            addResult('rawApiResult', '开始检查API原始响应...', 'info');
            
            if (!vikaStorage || !vikaStorage.isInitialized) {
                addResult('rawApiResult', '维格表存储未初始化', 'error');
                return;
            }
            
            try {
                // 直接调用API获取原始数据
                const params = {
                    fieldKey: vikaStorage.VIKA_CONFIG.fieldKey,
                    pageSize: 1000
                };
                
                const response = await vikaStorage.makeVikaRequest('GET', '', null, params);
                
                addResult('rawApiResult', `API响应状态: ${response ? '成功' : '失败'}`, response ? 'success' : 'error');
                
                if (response && response.data) {
                    addResult('rawApiResult', `总记录数: ${response.data.records ? response.data.records.length : 0}`, 'info');
                    addResult('rawApiResult', `是否有pageToken: ${response.data.pageToken ? '是' : '否'}`, 'info');
                    
                    if (response.data.records && response.data.records.length > 0) {
                        addResult('rawApiResult', `第一条记录结构: ${JSON.stringify(response.data.records[0], null, 2)}`, 'info');
                        
                        // 检查前几条记录的字段
                        const fieldSummary = {};
                        response.data.records.slice(0, 10).forEach((record, index) => {
                            if (record.fields) {
                                Object.keys(record.fields).forEach(fieldName => {
                                    if (!fieldSummary[fieldName]) {
                                        fieldSummary[fieldName] = [];
                                    }
                                    fieldSummary[fieldName].push(record.fields[fieldName]);
                                });
                            }
                        });
                        
                        addResult('rawApiResult', `前10条记录的字段汇总: ${JSON.stringify(fieldSummary, null, 2)}`, 'info');
                    }
                } else {
                    addResult('rawApiResult', '未获取到有效的API响应数据', 'error');
                }
                
            } catch (error) {
                addResult('rawApiResult', `API调用失败: ${error.message}`, 'error');
            }
        }

        // 2. 分析记录总数vs激活码数量
        async function analyzeRecordCount() {
            addResult('recordAnalysisResult', '开始分析记录数量...', 'info');
            
            if (!vikaStorage || !vikaStorage.isInitialized) {
                addResult('recordAnalysisResult', '维格表存储未初始化', 'error');
                return;
            }
            
            try {
                // 获取所有记录
                const allRecords = await vikaStorage.getRecords();
                addResult('recordAnalysisResult', `维格表总记录数: ${allRecords.length}`, 'info');
                
                // 获取激活码
                const codes = await vikaStorage.getActivationCodes();
                addResult('recordAnalysisResult', `解析出的激活码数量: ${Object.keys(codes).length}`, 'info');
                
                // 分析差异
                const difference = allRecords.length - Object.keys(codes).length;
                addResult('recordAnalysisResult', `记录数与激活码数量差异: ${difference}`, difference > 0 ? 'warning' : 'success');
                
                if (difference > 0) {
                    addResult('recordAnalysisResult', `有${difference}条记录没有被识别为激活码`, 'warning');
                    
                    // 分析未识别的记录
                    let unrecognizedCount = 0;
                    allRecords.forEach((record, index) => {
                        if (record.fields) {
                            let hasValidCode = false;
                            const possibleCodeFields = ['code', 'Code', 'CODE', 'activationCode', 'activation_code'];
                            
                            for (const fieldName of possibleCodeFields) {
                                if (record.fields[fieldName] && typeof record.fields[fieldName] === 'string') {
                                    if (/^[A-Za-z0-9]{6,}$/.test(record.fields[fieldName])) {
                                        hasValidCode = true;
                                        break;
                                    }
                                }
                            }
                            
                            if (!hasValidCode && unrecognizedCount < 5) {
                                addResult('recordAnalysisResult', `未识别记录${index + 1}: ${JSON.stringify(record.fields)}`, 'warning');
                                unrecognizedCount++;
                            }
                        }
                    });
                }
                
            } catch (error) {
                addResult('recordAnalysisResult', `分析失败: ${error.message}`, 'error');
            }
        }

        // 3. 测试不同的正则表达式
        async function testDifferentRegex() {
            addResult('regexTestResult', '测试不同的激活码识别规则...', 'info');
            
            if (!vikaStorage || !vikaStorage.isInitialized) {
                addResult('regexTestResult', '维格表存储未初始化', 'error');
                return;
            }
            
            try {
                const allRecords = await vikaStorage.getRecords();
                
                // 测试不同的正则表达式
                const regexTests = [
                    { name: '当前规则 (>=6位字母数字)', regex: /^[A-Za-z0-9]{6,}$/ },
                    { name: '宽松规则 (>=4位字母数字)', regex: /^[A-Za-z0-9]{4,}$/ },
                    { name: '更宽松 (>=3位字母数字)', regex: /^[A-Za-z0-9]{3,}$/ },
                    { name: '包含特殊字符 (字母数字下划线连字符)', regex: /^[A-Za-z0-9_-]{4,}$/ },
                    { name: '非空字符串', regex: /^.+$/ }
                ];
                
                const possibleCodeFields = ['code', 'Code', 'CODE', 'activationCode', 'activation_code'];
                
                regexTests.forEach(test => {
                    let matchCount = 0;
                    const matches = [];
                    
                    allRecords.forEach(record => {
                        if (record.fields) {
                            for (const fieldName of possibleCodeFields) {
                                if (record.fields[fieldName] && typeof record.fields[fieldName] === 'string') {
                                    if (test.regex.test(record.fields[fieldName])) {
                                        matchCount++;
                                        if (matches.length < 5) {
                                            matches.push(record.fields[fieldName]);
                                        }
                                        break;
                                    }
                                }
                            }
                        }
                    });
                    
                    addResult('regexTestResult', `${test.name}: 匹配${matchCount}个`, matchCount > 24 ? 'success' : 'warning');
                    if (matches.length > 0) {
                        addResult('regexTestResult', `  样本: ${matches.join(', ')}`, 'info');
                    }
                });
                
            } catch (error) {
                addResult('regexTestResult', `测试失败: ${error.message}`, 'error');
            }
        }

        // 4. 检查所有字段内容
        async function checkAllFieldContents() {
            addResult('fieldContentResult', '检查所有字段内容...', 'info');
            
            if (!vikaStorage || !vikaStorage.isInitialized) {
                addResult('fieldContentResult', '维格表存储未初始化', 'error');
                return;
            }
            
            try {
                const allRecords = await vikaStorage.getRecords();
                addResult('fieldContentResult', `总记录数: ${allRecords.length}`, 'info');
                
                // 统计所有字段名和其内容类型
                const fieldStats = {};
                
                allRecords.forEach((record, recordIndex) => {
                    if (record.fields) {
                        Object.entries(record.fields).forEach(([fieldName, value]) => {
                            if (!fieldStats[fieldName]) {
                                fieldStats[fieldName] = {
                                    count: 0,
                                    types: new Set(),
                                    samples: [],
                                    possibleCodes: []
                                };
                            }
                            
                            fieldStats[fieldName].count++;
                            fieldStats[fieldName].types.add(typeof value);
                            
                            // 保存样本
                            if (fieldStats[fieldName].samples.length < 3) {
                                fieldStats[fieldName].samples.push(value);
                            }
                            
                            // 检查是否可能是激活码
                            if (typeof value === 'string' && value.length >= 4) {
                                if (/^[A-Za-z0-9]{4,}$/.test(value)) {
                                    fieldStats[fieldName].possibleCodes.push(value);
                                }
                            }
                        });
                    }
                });
                
                // 输出字段统计
                Object.entries(fieldStats).forEach(([fieldName, stats]) => {
                    addResult('fieldContentResult', `字段 "${fieldName}":`, 'info');
                    addResult('fieldContentResult', `  出现次数: ${stats.count}/${allRecords.length}`, 'info');
                    addResult('fieldContentResult', `  数据类型: ${Array.from(stats.types).join(', ')}`, 'info');
                    addResult('fieldContentResult', `  样本值: ${JSON.stringify(stats.samples)}`, 'info');
                    
                    if (stats.possibleCodes.length > 0) {
                        addResult('fieldContentResult', `  可能的激活码(前5个): ${stats.possibleCodes.slice(0, 5).join(', ')}`, 'success');
                        addResult('fieldContentResult', `  激活码总数: ${stats.possibleCodes.length}`, 'success');
                    }
                });
                
            } catch (error) {
                addResult('fieldContentResult', `检查失败: ${error.message}`, 'error');
            }
        }

        // 5. 测试不同的fieldKey设置
        async function testFieldKeySettings() {
            addResult('fieldKeyResult', '测试不同的fieldKey设置...', 'info');
            
            if (!vikaStorage || !vikaStorage.isInitialized) {
                addResult('fieldKeyResult', '维格表存储未初始化', 'error');
                return;
            }
            
            try {
                const results = await vikaStorage.testDifferentFieldKeys();
                
                Object.entries(results).forEach(([fieldKey, result]) => {
                    if (result.error) {
                        addResult('fieldKeyResult', `fieldKey=${fieldKey}: 失败 - ${result.error}`, 'error');
                    } else {
                        addResult('fieldKeyResult', `fieldKey=${fieldKey}: ${result.recordCount}条记录`, 'success');
                        addResult('fieldKeyResult', `  有下一页: ${result.hasPageToken ? '是' : '否'}`, 'info');
                        
                        if (result.sampleRecord && result.sampleRecord.fields) {
                            const fieldNames = Object.keys(result.sampleRecord.fields);
                            addResult('fieldKeyResult', `  字段名: ${fieldNames.join(', ')}`, 'info');
                            
                            // 检查是否有可能的激活码字段
                            const codeFields = fieldNames.filter(name => 
                                ['code', 'Code', 'CODE', 'activationCode', 'activation_code'].includes(name)
                            );
                            if (codeFields.length > 0) {
                                addResult('fieldKeyResult', `  激活码字段: ${codeFields.join(', ')}`, 'success');
                            }
                        }
                    }
                });
                
                addResult('fieldKeyResult', '建议: 如果某个fieldKey返回更多记录，可以尝试修改配置', 'info');
                
            } catch (error) {
                addResult('fieldKeyResult', `测试失败: ${error.message}`, 'error');
            }
        }

        // 6. 测试分页逻辑
        async function testPaginationLogic() {
            addResult('paginationResult', '测试分页逻辑...', 'info');
            
            if (!vikaStorage || !vikaStorage.isInitialized) {
                addResult('paginationResult', '维格表存储未初始化', 'error');
                return;
            }
            
            try {
                // 手动实现分页测试
                let allRecords = [];
                let pageToken = null;
                let pageCount = 0;
                
                do {
                    const params = {
                        fieldKey: vikaStorage.VIKA_CONFIG.fieldKey,
                        pageSize: 100 // 使用较小的页面大小来测试分页
                    };
                    
                    if (pageToken) {
                        params.pageToken = pageToken;
                    }
                    
                    addResult('paginationResult', `请求第${pageCount + 1}页...`, 'info');
                    const response = await vikaStorage.makeVikaRequest('GET', '', null, params);
                    
                    if (response.data && response.data.records) {
                        const records = response.data.records;
                        allRecords = allRecords.concat(records);
                        addResult('paginationResult', `第${pageCount + 1}页获取到 ${records.length} 条记录`, 'success');
                        
                        pageToken = response.data.pageToken;
                        pageCount++;
                        
                        if (pageCount >= 10) {
                            addResult('paginationResult', '达到最大页数限制，停止测试', 'warning');
                            break;
                        }
                    } else {
                        addResult('paginationResult', '没有更多数据', 'info');
                        break;
                    }
                    
                } while (pageToken);
                
                addResult('paginationResult', `分页测试完成，总共获取 ${allRecords.length} 条记录，${pageCount} 页`, 'success');
                
            } catch (error) {
                addResult('paginationResult', `分页测试失败: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
