<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å•æµ‹è¯•é¡µé¢</title>
    <!-- ä½¿ç”¨CDNæˆ–æœ¬åœ°ç‰ˆæœ¬çš„Vika SDK -->
    <!-- <script src="https://unpkg.com/@vikadata/vika@latest/dist/vika.js"></script> -->
    <script>
        // ç­‰å¾…Vika SDKåŠ è½½å®Œæˆ
        function waitForVikaSDK() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50; // ç­‰å¾…5ç§’
                
                const checkVika = () => {
                    attempts++;
                    if (typeof Vika !== 'undefined') {
                        resolve(Vika);
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('Vika SDKåŠ è½½è¶…æ—¶'));
                    } else {
                        setTimeout(checkVika, 100);
                    }
                };
                
                checkVika();
            });
        }
        
        // åŠ¨æ€åŠ è½½Vika SDK
        function loadVikaSDK() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/@vikadata/vika@latest/dist/vika.js';
                script.onload = () => {
                    console.log('âœ… Vika SDKåŠ è½½æˆåŠŸ');
                    resolve();
                };
                script.onerror = () => {
                    console.error('âŒ Vika SDKåŠ è½½å¤±è´¥');
                    reject(new Error('Vika SDKåŠ è½½å¤±è´¥'));
                };
                document.head.appendChild(script);
            });
        }
    </script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        button { padding: 10px 20px; margin: 5px; }
        .log { background: #f5f5f5; padding: 10px; height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>æ¿€æ´»ç åŒè¡¨æµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>æµ‹è¯•æ•°æ®</h3>
        <button onclick="testWriteToSecondTable()">å†™å…¥ç¬¬äºŒä¸ªè¡¨</button>
        <button onclick="testReadFromSecondTable()">è¯»å–ç¬¬äºŒä¸ªè¡¨</button>
        <button onclick="testUseCode()">ä½¿ç”¨æ¿€æ´»ç </button>
        
        <h4>æ—¥å¿—</h4>
        <div id="log" class="log"></div>
    </div>

    <script src="cloud-storage-vika-v2.js"></script>
    <script>
        let vikaStorage = null;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                log('ğŸ”„ å¼€å§‹åˆå§‹åŒ–...');
                
                // ç¡®ä¿VikaCloudStorageå·²å®šä¹‰
                if (typeof VikaCloudStorage !== 'undefined') {
                    log('âœ… VikaCloudStorageç±»å·²åŠ è½½');
                } else {
                    log('âŒ VikaCloudStorageç±»æœªåŠ è½½');
                    return;
                }
                
                // åŠ¨æ€åŠ è½½Vika SDK
                await loadVikaSDK();
                
                // ç­‰å¾…Vika SDKå°±ç»ª
                await waitForVikaSDK();
                
                log('âœ… Vika SDKåŠ è½½æˆåŠŸ');
                
                // åˆå§‹åŒ–å­˜å‚¨ï¼ˆæ”¹ä¸ºç›´æ¥åˆ›å»ºå®ä¾‹ï¼‰
                vikaStorage = new VikaCloudStorage();
                
                // ç­‰å¾…å­˜å‚¨åˆå§‹åŒ–å®Œæˆ
                try {
                    await vikaStorage.getActivationCodes();
                    log('âœ… å­˜å‚¨è¿æ¥æˆåŠŸ');
                } catch (error) {
                    log('âš ï¸ å­˜å‚¨è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message);
                }
                
                // æµ‹è¯•SDKå¯ç”¨æ€§
                const vika = new Vika({ token: 'uskNUrvWvJoD3VuQ5zW7GYH', fieldKey: "name" });
                const datasheet = vika.datasheet("dstVZvdm5sqCs9NFY4");
                log('âœ… SDKæµ‹è¯•æˆåŠŸ');
                
            } catch (error) {
                log('âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                console.error('åˆå§‹åŒ–é”™è¯¯:', error);
            }
        });

        function log(message) {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${time}] ${message}<br>`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        // æµ‹è¯•ç›´æ¥å†™å…¥ç¬¬äºŒä¸ªè¡¨
        async function testWriteToSecondTable() {
            try {
                log('å¼€å§‹æµ‹è¯•å†™å…¥ç¬¬äºŒä¸ªè¡¨...');
                log(`å½“å‰Vikaå¯¹è±¡çŠ¶æ€: ${typeof Vika !== 'undefined' ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½'}`);
                
                if (typeof Vika === 'undefined') {
                    throw new Error('Vika SDKæœªåŠ è½½');
                }
                
                const testCode = 'TEST' + Date.now().toString().slice(-5);
                log(`æµ‹è¯•æ¿€æ´»ç : ${testCode}`);
                
                // ç›´æ¥ä½¿ç”¨Vika SDK
                const vika = new Vika({ token: 'uskNUrvWvJoD3VuQ5zW7GYH', fieldKey: "name" });
                const usageDatasheet = vika.datasheet("dstz67JjuBawS8Zam0");
                
                const writeData = [{
                    fields: {
                        "codeused": testCode,
                        "usedAt": new Date().toISOString(),
                        "userAgent": navigator.userAgent.slice(0, 50),
                        "timestamp": new Date().toISOString()
                    }
                }];
                
                log(`å‡†å¤‡å†™å…¥æ•°æ®: ${JSON.stringify(writeData)}`);
                
                const writeResponse = await usageDatasheet.records.create(writeData);
                
                log(`å†™å…¥å“åº”: ${JSON.stringify(writeResponse)}`);
                
                if (writeResponse.success) {
                    log('âœ… å†™å…¥æˆåŠŸ');
                    
                    // éªŒè¯å†™å…¥ - ç›´æ¥è¯»å–
                    const readResponse = await usageDatasheet.records.get({
                        params: {
                            viewId: null, // è·å–æ‰€æœ‰è®°å½•
                        }
                    });
                    
                    if (readResponse.success) {
                        const records = readResponse.data.records;
                        const foundRecord = records.find(r => r.fields.codeused === testCode);
                        log(`${foundRecord ? 'âœ… éªŒè¯æˆåŠŸï¼Œæ‰¾åˆ°è®°å½•' : 'âš ï¸ éªŒè¯å¤±è´¥ï¼Œæœªæ‰¾åˆ°è®°å½•'}`);
                        log(`éªŒè¯è®°å½•: ${JSON.stringify(foundRecord)}`);
                    } else {
                        log('âŒ éªŒè¯è¯»å–å¤±è´¥: ' + JSON.stringify(readResponse));
                    }
                } else {
                    log('âŒ å†™å…¥å¤±è´¥: ' + JSON.stringify(writeResponse));
                }
                
            } catch (error) {
                log('âŒ å†™å…¥å¤±è´¥: ' + error.message);
                console.error('å†™å…¥é”™è¯¯:', error);
            }
        }

        // æµ‹è¯•è¯»å–ç¬¬äºŒä¸ªè¡¨
        async function testReadFromSecondTable() {
            try {
                log('å¼€å§‹æµ‹è¯•è¯»å–ç¬¬äºŒä¸ªè¡¨...');
                
                const records = await vikaStorage.getUsageRecords();
                
                log(`âœ… è¯»å–æˆåŠŸï¼Œå…± ${records.length} æ¡è®°å½•`);
                
                records.forEach((record, index) => {
                    const fields = record.fields;
                    log(`è®°å½• ${index + 1}: ${JSON.stringify(fields)}`);
                });
                
            } catch (error) {
                log('âŒ è¯»å–å¤±è´¥: ' + error.message);
                console.error('è¯»å–é”™è¯¯:', error);
            }
        }

        // æµ‹è¯•ä½¿ç”¨æ¿€æ´»ç 
        async function testUseCode() {
            try {
                log('å¼€å§‹æµ‹è¯•ä½¿ç”¨æ¿€æ´»ç ...');
                
                if (!vikaStorage) {
                    log('âŒ VikaCloudStorageæœªåˆå§‹åŒ–');
                    return;
                }
                
                // ä½¿ç”¨ç°æœ‰çš„æ¿€æ´»ç è¿›è¡Œæµ‹è¯•ï¼ˆé¿å…åˆ›å»ºæ–°ç ï¼‰
                const existingCodes = await vikaStorage.getActivationCodes();
                const availableCodes = Object.keys(existingCodes).filter(code => !existingCodes[code].isUsed);
                
                if (availableCodes.length === 0) {
                    log('âŒ æ²¡æœ‰å¯ç”¨çš„æ¿€æ´»ç è¿›è¡Œæµ‹è¯•');
                    return;
                }
                
                const selectedCode = availableCodes[0];
                log(`ä½¿ç”¨ç°æœ‰æ¿€æ´»ç : ${selectedCode}`);
                
                // ä½¿ç”¨æ¿€æ´»ç 
                const deviceInfo = {
                    deviceId: 'test-device-' + Date.now(),
                    userAgent: navigator.userAgent.slice(0, 50),
                    timestamp: new Date().toISOString(),
                    platform: 'test',
                    language: 'zh-CN'
                };
                
                log('å‡†å¤‡ä½¿ç”¨æ¿€æ´»ç ...');
                const result = await vikaStorage.useActivationCode(selectedCode, deviceInfo);
                
                log('âœ… ä½¿ç”¨ç»“æœ: ' + JSON.stringify(result));
                
                // éªŒè¯æ˜¯å¦å†™å…¥äº†ç¬¬äºŒä¸ªè¡¨
                const used = await vikaStorage.checkUsageTable(selectedCode);
                log(`âœ… ç¬¬ä¸€ä¸ªè¡¨éªŒè¯: ${used ? 'å·²å†™å…¥' : 'æœªå†™å…¥'}`);
                
            } catch (error) {
                log('âŒ ä½¿ç”¨å¤±è´¥: ' + error.message);
                console.error('ä½¿ç”¨é”™è¯¯:', error);
            }
        }
    </script>
</body>
</html>
