<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vika APIæœ¬åœ°æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-button:hover { background: #0056b3; }
        .result {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { border-color: #28a745; background: #f8fff8; }
        .error { border-color: #dc3545; background: #fff8f8; }
        .config { background: #e9ecef; padding: 15px; border-radius: 6px; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Vikaç»´æ ¼è¡¨APIæœ¬åœ°æµ‹è¯•</h1>
        
        <div class="config">
            <h3>ğŸ“Š Vikaé…ç½®ä¿¡æ¯</h3>
            <p><strong>Token:</strong> uskNUrvWvJoD3VuQ5zW7GYH</p>
            <p><strong>Datasheet ID:</strong> dstVZvdm5sqCs9NFY4</p>
            <p><strong>View ID:</strong> viwBCtFiuGWiT</p>
            <p><strong>API URL:</strong> https://api.vika.cn/fusion/v1/</p>
        </div>

        <div class="test-section">
            <h3>ğŸ”Œ åŸºç¡€è¿æ¥æµ‹è¯•</h3>
            <button class="test-button" onclick="testVikaConnection()">æµ‹è¯•Vikaè¿æ¥</button>
            <button class="test-button" onclick="getVikaRecords()">è·å–è®°å½•</button>
            <button class="test-button" onclick="createTestRecord()">åˆ›å»ºæµ‹è¯•è®°å½•</button>
            <div id="connectionResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ æ¿€æ´»ç ç®¡ç†æµ‹è¯•</h3>
            <button class="test-button" onclick="testActivationCodes()">æµ‹è¯•æ¿€æ´»ç åŠŸèƒ½</button>
            <button class="test-button" onclick="addTestCode()">æ·»åŠ æµ‹è¯•æ¿€æ´»ç </button>
            <button class="test-button" onclick="useTestCode()">ä½¿ç”¨æ¿€æ´»ç </button>
            <div id="codesResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>ğŸš€ Vikaå­˜å‚¨ç³»ç»Ÿæµ‹è¯•</h3>
            <button class="test-button" onclick="testVikaStorage()">æµ‹è¯•Vikaå­˜å‚¨</button>
            <button class="test-button" onclick="testSync()">æµ‹è¯•åŒæ­¥</button>
            <div id="storageResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <!-- æš‚æ—¶æ³¨é‡Šæ‰vika-storage.jsï¼Œç›´æ¥åœ¨é¡µé¢ä¸­æµ‹è¯•API -->
    <!-- <script src="public/vika-storage.js"></script> -->
    <script>
        // Vikaé…ç½®
        const VIKA_CONFIG = {
            token: 'uskNUrvWvJoD3VuQ5zW7GYH',
            datasheetId: 'dstVZvdm5sqCs9NFY4',
            viewId: 'viwBCtFiuGWiT',
            apiUrl: 'https://api.vika.cn/fusion/v1/',
            fieldKey: 'name'
        };

        function showResult(containerId, content, type = 'success') {
            const container = document.getElementById(containerId);
            container.style.display = 'block';
            container.className = `result ${type}`;
            container.textContent = content;
        }

        async function testVikaConnection() {
            showResult('connectionResult', 'æ­£åœ¨æµ‹è¯•Vikaè¿æ¥...', 'info');
            
            try {
                const response = await fetch(`${VIKA_CONFIG.apiUrl}datasheets/${VIKA_CONFIG.datasheetId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${VIKA_CONFIG.token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResult('connectionResult', `âœ… Vikaè¿æ¥æˆåŠŸï¼
çŠ¶æ€ç : ${response.status}
ç»´æ ¼è¡¨åç§°: ${result.data.name}
ç»´æ ¼è¡¨ID: ${result.data.id}
å­—æ®µæ•°é‡: ${result.data.fields.length}

å“åº”æ•°æ®:
${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    throw new Error(`APIé”™è¯¯: ${JSON.stringify(result)}`);
                }
            } catch (error) {
                showResult('connectionResult', `âŒ Vikaè¿æ¥å¤±è´¥
é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function getVikaRecords() {
            showResult('connectionResult', 'æ­£åœ¨è·å–Vikaè®°å½•...', 'info');
            
            try {
                const response = await fetch(`${VIKA_CONFIG.apiUrl}datasheets/${VIKA_CONFIG.datasheetId}/records?viewId=${VIKA_CONFIG.viewId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${VIKA_CONFIG.token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResult('connectionResult', `âœ… è®°å½•è·å–æˆåŠŸï¼
è®°å½•æ•°é‡: ${result.data.records.length}
æ€»è®°å½•æ•°: ${result.data.total}

è®°å½•è¯¦æƒ…:
${JSON.stringify(result.data.records, null, 2)}`, 'success');
                } else {
                    throw new Error(`APIé”™è¯¯: ${JSON.stringify(result)}`);
                }
            } catch (error) {
                showResult('connectionResult', `âŒ è®°å½•è·å–å¤±è´¥
é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function createTestRecord() {
            showResult('connectionResult', 'æ­£åœ¨åˆ›å»ºæµ‹è¯•è®°å½•...', 'info');
            
            try {
                const testRecord = {
                    records: [{
                        fields: {
                            type: 'activation_code',
                            code: 'TEST' + Date.now(),
                            used: false,
                            created_at: new Date().toISOString()
                        }
                    }],
                    fieldKey: VIKA_CONFIG.fieldKey
                };

                const response = await fetch(`${VIKA_CONFIG.apiUrl}datasheets/${VIKA_CONFIG.datasheetId}/records`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${VIKA_CONFIG.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testRecord)
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResult('connectionResult', `âœ… æµ‹è¯•è®°å½•åˆ›å»ºæˆåŠŸï¼
è®°å½•ID: ${result.data.records[0].recordId}
æ¿€æ´»ç : ${result.data.records[0].fields.code}

å“åº”æ•°æ®:
${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    throw new Error(`APIé”™è¯¯: ${JSON.stringify(result)}`);
                }
            } catch (error) {
                showResult('connectionResult', `âŒ è®°å½•åˆ›å»ºå¤±è´¥
é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testActivationCodes() {
            showResult('codesResult', 'æ­£åœ¨æµ‹è¯•æ¿€æ´»ç åŠŸèƒ½...', 'info');
            
            try {
                // æ¨¡æ‹Ÿæ¿€æ´»ç æ•°æ®
                const testCodes = {
                    'ABC123DEF456': {
                        used: false,
                        createdAt: new Date().toISOString(),
                        usedAt: null,
                        deviceFingerprint: null,
                        userAgent: null
                    },
                    'XYZ789GHI012': {
                        used: true,
                        createdAt: new Date(Date.now() - 86400000).toISOString(),
                        usedAt: new Date().toISOString(),
                        deviceFingerprint: 'test_device_123',
                        userAgent: 'Mozilla/5.0 Test Browser'
                    }
                };

                showResult('codesResult', `âœ… æ¿€æ´»ç åŠŸèƒ½æµ‹è¯•å®Œæˆï¼
æµ‹è¯•æ¿€æ´»ç æ•°é‡: ${Object.keys(testCodes).length}
å¯ç”¨æ¿€æ´»ç : ${Object.values(testCodes).filter(c => !c.used).length}
å·²ä½¿ç”¨æ¿€æ´»ç : ${Object.values(testCodes).filter(c => c.used).length}

æ¿€æ´»ç è¯¦æƒ…:
${JSON.stringify(testCodes, null, 2)}`, 'success');
            } catch (error) {
                showResult('codesResult', `âŒ æ¿€æ´»ç æµ‹è¯•å¤±è´¥
é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function addTestCode() {
            showResult('codesResult', 'æ­£åœ¨æ·»åŠ æµ‹è¯•æ¿€æ´»ç ...', 'info');
            
            const testCode = 'LOCAL' + Date.now().toString().slice(-6);
            
            try {
                const newRecord = {
                    records: [{
                        fields: {
                            type: 'activation_code',
                            code: testCode,
                            used: false,
                            created_at: new Date().toISOString(),
                            used_at: null,
                            device_fingerprint: null,
                            user_agent: null
                        }
                    }],
                    fieldKey: VIKA_CONFIG.fieldKey
                };

                const response = await fetch(`${VIKA_CONFIG.apiUrl}datasheets/${VIKA_CONFIG.datasheetId}/records`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${VIKA_CONFIG.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newRecord)
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResult('codesResult', `âœ… æµ‹è¯•æ¿€æ´»ç æ·»åŠ æˆåŠŸï¼
æ¿€æ´»ç : ${testCode}
è®°å½•ID: ${result.data.records[0].recordId}
åˆ›å»ºæ—¶é—´: ${result.data.records[0].fields.created_at}`, 'success');
                } else {
                    throw new Error(`APIé”™è¯¯: ${JSON.stringify(result)}`);
                }
            } catch (error) {
                showResult('codesResult', `âŒ æ¿€æ´»ç æ·»åŠ å¤±è´¥
é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function useTestCode() {
            showResult('codesResult', 'æ­£åœ¨æ¨¡æ‹Ÿä½¿ç”¨æ¿€æ´»ç ...', 'info');
            
            try {
                // è¿™é‡Œåªæ˜¯æ¨¡æ‹Ÿï¼Œå®é™…ä½¿ç”¨éœ€è¦å…ˆè·å–è®°å½•IDç„¶åæ›´æ–°
                const mockUsage = {
                    code: 'TEST123456',
                    usedAt: new Date().toISOString(),
                    deviceFingerprint: 'local_test_device_' + Date.now(),
                    userAgent: navigator.userAgent
                };

                showResult('codesResult', `âœ… æ¿€æ´»ç ä½¿ç”¨æ¨¡æ‹ŸæˆåŠŸï¼
æ¿€æ´»ç : ${mockUsage.code}
ä½¿ç”¨æ—¶é—´: ${mockUsage.usedAt}
è®¾å¤‡æŒ‡çº¹: ${mockUsage.deviceFingerprint}
ç”¨æˆ·ä»£ç†: ${mockUsage.userAgent}

æ³¨æ„: è¿™æ˜¯æ¨¡æ‹Ÿæµ‹è¯•ï¼Œå®é™…ä½¿ç”¨éœ€è¦å…ˆæŸ¥è¯¢è®°å½•IDå†æ›´æ–°è®°å½•`, 'success');
            } catch (error) {
                showResult('codesResult', `âŒ æ¿€æ´»ç ä½¿ç”¨å¤±è´¥
é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testVikaStorage() {
            showResult('storageResult', 'æ­£åœ¨æµ‹è¯•Vikaå­˜å‚¨ç³»ç»Ÿ...', 'info');
            
            try {
                // æ¨¡æ‹Ÿå­˜å‚¨ç³»ç»Ÿæµ‹è¯•ï¼Œç›´æ¥è°ƒç”¨Vika API
                const response = await fetch(`${VIKA_CONFIG.apiUrl}datasheets/${VIKA_CONFIG.datasheetId}/records?viewId=${VIKA_CONFIG.viewId}&maxRecords=5`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${VIKA_CONFIG.token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    // åˆ†æè®°å½•ç±»å‹
                    const records = result.data.records || [];
                    const codeRecords = records.filter(r => r.fields.type === 'activation_code' || !r.fields.type);
                    const logRecords = records.filter(r => r.fields.type === 'activation_log');
                    
                    showResult('storageResult', `âœ… Vikaå­˜å‚¨ç³»ç»Ÿæµ‹è¯•æˆåŠŸï¼
è¿æ¥çŠ¶æ€: å·²è¿æ¥
æ€»è®°å½•æ•°: ${records.length}
æ¿€æ´»ç è®°å½•: ${codeRecords.length}
æ—¥å¿—è®°å½•: ${logRecords.length}
æµ‹è¯•æ—¶é—´: ${new Date().toLocaleString()}

è®°å½•è¯¦æƒ…:
${JSON.stringify(records.slice(0, 3), null, 2)}`, 'success');
                } else {
                    throw new Error(`APIé”™è¯¯: ${JSON.stringify(result)}`);
                }
            } catch (error) {
                showResult('storageResult', `âŒ Vikaå­˜å‚¨æµ‹è¯•å¤±è´¥
é”™è¯¯: ${error.message}

å¯èƒ½çš„åŸå› :
1. Tokenæƒé™ä¸è¶³
2. ç»´æ ¼è¡¨IDé”™è¯¯
3. ç½‘ç»œè¿æ¥é—®é¢˜
4. CORSè·¨åŸŸé™åˆ¶`, 'error');
            }
        }

        async function testSync() {
            showResult('storageResult', 'æ­£åœ¨æµ‹è¯•åŒæ­¥åŠŸèƒ½...', 'info');
            
            try {
                // æ¨¡æ‹ŸåŒæ­¥æµ‹è¯• - è·å–æ•°æ®ç„¶åæ¨¡æ‹Ÿæœ¬åœ°å­˜å‚¨
                const response = await fetch(`${VIKA_CONFIG.apiUrl}datasheets/${VIKA_CONFIG.datasheetId}/records?viewId=${VIKA_CONFIG.viewId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${VIKA_CONFIG.token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    // æ¨¡æ‹Ÿä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    const syncData = {
                        records: result.data.records,
                        syncTime: new Date().toISOString(),
                        source: 'Vikaç»´æ ¼è¡¨'
                    };
                    
                    localStorage.setItem('vika_sync_test', JSON.stringify(syncData));
                    
                    showResult('storageResult', `âœ… åŒæ­¥æµ‹è¯•å®Œæˆï¼
åŒæ­¥ç»“æœ: æˆåŠŸ
åŒæ­¥è®°å½•æ•°: ${result.data.records.length}
åŒæ­¥æ—¶é—´: ${syncData.syncTime}
æœ¬åœ°å­˜å‚¨: å·²ä¿å­˜

è¿™æ¨¡æ‹Ÿäº†ä»Vikaç»´æ ¼è¡¨åŒæ­¥æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨çš„è¿‡ç¨‹`, 'success');
                } else {
                    throw new Error(`åŒæ­¥å¤±è´¥: ${JSON.stringify(result)}`);
                }
            } catch (error) {
                showResult('storageResult', `âŒ åŒæ­¥æµ‹è¯•å¤±è´¥
é”™è¯¯: ${error.message}

å¯èƒ½çš„åŸå› :
1. ç½‘ç»œè¿æ¥é—®é¢˜
2. APIæƒé™ä¸è¶³
3. ç»´æ ¼è¡¨é…ç½®é”™è¯¯`, 'error');
            }
        }

        // æ·»åŠ è°ƒè¯•åŠŸèƒ½
        function debugTest() {
            console.log('ğŸ”§ è°ƒè¯•æµ‹è¯•è¢«ç‚¹å‡»');
            showResult('connectionResult', `ğŸ”§ è°ƒè¯•æµ‹è¯•æˆåŠŸï¼
é¡µé¢åŠ è½½æ—¶é—´: ${new Date().toLocaleString()}
JavaScriptè¿è¡Œæ­£å¸¸: âœ…
æŒ‰é’®ç‚¹å‡»å“åº”: âœ…
æ§åˆ¶å°è¾“å‡º: è¯·æ£€æŸ¥æµè§ˆå™¨å¼€å‘è€…å·¥å…·æ§åˆ¶å°

å¦‚æœçœ‹åˆ°è¿™ä¸ªæ¶ˆæ¯ï¼Œè¯´æ˜JavaScriptæ­£å¸¸å·¥ä½œ`, 'success');
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æµ‹è¯•è¿æ¥
        window.addEventListener('load', () => {
            console.log('ğŸš€ Vika APIæœ¬åœ°æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            
            // æ·»åŠ è°ƒè¯•æŒ‰é’®
            const debugButton = document.createElement('button');
            debugButton.className = 'test-button';
            debugButton.textContent = 'ğŸ”§ è°ƒè¯•æµ‹è¯•';
            debugButton.onclick = debugTest;
            
            const firstSection = document.querySelector('.test-section');
            firstSection.insertBefore(debugButton, firstSection.querySelector('button'));
            
            setTimeout(() => {
                console.log('å¼€å§‹è‡ªåŠ¨è¿æ¥æµ‹è¯•...');
                testVikaConnection();
            }, 1000);
        });
    </script>
</body>
</html>
