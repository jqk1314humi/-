<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vika API本地测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #007bff;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-button:hover { background: #0056b3; }
        .result {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { border-color: #28a745; background: #f8fff8; }
        .error { border-color: #dc3545; background: #fff8f8; }
        .config { background: #e9ecef; padding: 15px; border-radius: 6px; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Vika维格表API本地测试</h1>
        
        <div class="config">
            <h3>📊 Vika配置信息</h3>
            <p><strong>Token:</strong> uskNUrvWvJoD3VuQ5zW7GYH</p>
            <p><strong>Datasheet ID:</strong> dstVZvdm5sqCs9NFY4</p>
            <p><strong>View ID:</strong> viwBCtFiuGWiT</p>
            <p><strong>API URL:</strong> https://api.vika.cn/fusion/v1/</p>
        </div>

        <div class="test-section">
            <h3>🔌 基础连接测试</h3>
            <button class="test-button" onclick="testVikaConnection()">测试Vika连接</button>
            <button class="test-button" onclick="getVikaRecords()">获取记录</button>
            <button class="test-button" onclick="createTestRecord()">创建测试记录</button>
            <div id="connectionResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>📝 激活码管理测试</h3>
            <button class="test-button" onclick="testActivationCodes()">测试激活码功能</button>
            <button class="test-button" onclick="addTestCode()">添加测试激活码</button>
            <button class="test-button" onclick="useTestCode()">使用激活码</button>
            <div id="codesResult" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>🚀 Vika存储系统测试</h3>
            <button class="test-button" onclick="testVikaStorage()">测试Vika存储</button>
            <button class="test-button" onclick="testSync()">测试同步</button>
            <div id="storageResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <!-- 暂时注释掉vika-storage.js，直接在页面中测试API -->
    <!-- <script src="public/vika-storage.js"></script> -->
    <script>
        // Vika配置
        const VIKA_CONFIG = {
            token: 'uskNUrvWvJoD3VuQ5zW7GYH',
            datasheetId: 'dstVZvdm5sqCs9NFY4',
            viewId: 'viwBCtFiuGWiT',
            apiUrl: 'https://api.vika.cn/fusion/v1/',
            fieldKey: 'name'
        };

        function showResult(containerId, content, type = 'success') {
            const container = document.getElementById(containerId);
            container.style.display = 'block';
            container.className = `result ${type}`;
            container.textContent = content;
        }

        async function testVikaConnection() {
            showResult('connectionResult', '正在测试Vika连接...', 'info');
            
            try {
                const response = await fetch(`${VIKA_CONFIG.apiUrl}datasheets/${VIKA_CONFIG.datasheetId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${VIKA_CONFIG.token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResult('connectionResult', `✅ Vika连接成功！
状态码: ${response.status}
维格表名称: ${result.data.name}
维格表ID: ${result.data.id}
字段数量: ${result.data.fields.length}

响应数据:
${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    throw new Error(`API错误: ${JSON.stringify(result)}`);
                }
            } catch (error) {
                showResult('connectionResult', `❌ Vika连接失败
错误: ${error.message}`, 'error');
            }
        }

        async function getVikaRecords() {
            showResult('connectionResult', '正在获取Vika记录...', 'info');
            
            try {
                const response = await fetch(`${VIKA_CONFIG.apiUrl}datasheets/${VIKA_CONFIG.datasheetId}/records?viewId=${VIKA_CONFIG.viewId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${VIKA_CONFIG.token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResult('connectionResult', `✅ 记录获取成功！
记录数量: ${result.data.records.length}
总记录数: ${result.data.total}

记录详情:
${JSON.stringify(result.data.records, null, 2)}`, 'success');
                } else {
                    throw new Error(`API错误: ${JSON.stringify(result)}`);
                }
            } catch (error) {
                showResult('connectionResult', `❌ 记录获取失败
错误: ${error.message}`, 'error');
            }
        }

        async function createTestRecord() {
            showResult('connectionResult', '正在创建测试记录...', 'info');
            
            try {
                const testRecord = {
                    records: [{
                        fields: {
                            type: 'activation_code',
                            code: 'TEST' + Date.now(),
                            used: false,
                            created_at: new Date().toISOString()
                        }
                    }],
                    fieldKey: VIKA_CONFIG.fieldKey
                };

                const response = await fetch(`${VIKA_CONFIG.apiUrl}datasheets/${VIKA_CONFIG.datasheetId}/records`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${VIKA_CONFIG.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testRecord)
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResult('connectionResult', `✅ 测试记录创建成功！
记录ID: ${result.data.records[0].recordId}
激活码: ${result.data.records[0].fields.code}

响应数据:
${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    throw new Error(`API错误: ${JSON.stringify(result)}`);
                }
            } catch (error) {
                showResult('connectionResult', `❌ 记录创建失败
错误: ${error.message}`, 'error');
            }
        }

        async function testActivationCodes() {
            showResult('codesResult', '正在测试激活码功能...', 'info');
            
            try {
                // 模拟激活码数据
                const testCodes = {
                    'ABC123DEF456': {
                        used: false,
                        createdAt: new Date().toISOString(),
                        usedAt: null,
                        deviceFingerprint: null,
                        userAgent: null
                    },
                    'XYZ789GHI012': {
                        used: true,
                        createdAt: new Date(Date.now() - 86400000).toISOString(),
                        usedAt: new Date().toISOString(),
                        deviceFingerprint: 'test_device_123',
                        userAgent: 'Mozilla/5.0 Test Browser'
                    }
                };

                showResult('codesResult', `✅ 激活码功能测试完成！
测试激活码数量: ${Object.keys(testCodes).length}
可用激活码: ${Object.values(testCodes).filter(c => !c.used).length}
已使用激活码: ${Object.values(testCodes).filter(c => c.used).length}

激活码详情:
${JSON.stringify(testCodes, null, 2)}`, 'success');
            } catch (error) {
                showResult('codesResult', `❌ 激活码测试失败
错误: ${error.message}`, 'error');
            }
        }

        async function addTestCode() {
            showResult('codesResult', '正在添加测试激活码...', 'info');
            
            const testCode = 'LOCAL' + Date.now().toString().slice(-6);
            
            try {
                const newRecord = {
                    records: [{
                        fields: {
                            type: 'activation_code',
                            code: testCode,
                            used: false,
                            created_at: new Date().toISOString(),
                            used_at: null,
                            device_fingerprint: null,
                            user_agent: null
                        }
                    }],
                    fieldKey: VIKA_CONFIG.fieldKey
                };

                const response = await fetch(`${VIKA_CONFIG.apiUrl}datasheets/${VIKA_CONFIG.datasheetId}/records`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${VIKA_CONFIG.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newRecord)
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResult('codesResult', `✅ 测试激活码添加成功！
激活码: ${testCode}
记录ID: ${result.data.records[0].recordId}
创建时间: ${result.data.records[0].fields.created_at}`, 'success');
                } else {
                    throw new Error(`API错误: ${JSON.stringify(result)}`);
                }
            } catch (error) {
                showResult('codesResult', `❌ 激活码添加失败
错误: ${error.message}`, 'error');
            }
        }

        async function useTestCode() {
            showResult('codesResult', '正在模拟使用激活码...', 'info');
            
            try {
                // 这里只是模拟，实际使用需要先获取记录ID然后更新
                const mockUsage = {
                    code: 'TEST123456',
                    usedAt: new Date().toISOString(),
                    deviceFingerprint: 'local_test_device_' + Date.now(),
                    userAgent: navigator.userAgent
                };

                showResult('codesResult', `✅ 激活码使用模拟成功！
激活码: ${mockUsage.code}
使用时间: ${mockUsage.usedAt}
设备指纹: ${mockUsage.deviceFingerprint}
用户代理: ${mockUsage.userAgent}

注意: 这是模拟测试，实际使用需要先查询记录ID再更新记录`, 'success');
            } catch (error) {
                showResult('codesResult', `❌ 激活码使用失败
错误: ${error.message}`, 'error');
            }
        }

        async function testVikaStorage() {
            showResult('storageResult', '正在测试Vika存储系统...', 'info');
            
            try {
                // 模拟存储系统测试，直接调用Vika API
                const response = await fetch(`${VIKA_CONFIG.apiUrl}datasheets/${VIKA_CONFIG.datasheetId}/records?viewId=${VIKA_CONFIG.viewId}&maxRecords=5`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${VIKA_CONFIG.token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    // 分析记录类型
                    const records = result.data.records || [];
                    const codeRecords = records.filter(r => r.fields.type === 'activation_code' || !r.fields.type);
                    const logRecords = records.filter(r => r.fields.type === 'activation_log');
                    
                    showResult('storageResult', `✅ Vika存储系统测试成功！
连接状态: 已连接
总记录数: ${records.length}
激活码记录: ${codeRecords.length}
日志记录: ${logRecords.length}
测试时间: ${new Date().toLocaleString()}

记录详情:
${JSON.stringify(records.slice(0, 3), null, 2)}`, 'success');
                } else {
                    throw new Error(`API错误: ${JSON.stringify(result)}`);
                }
            } catch (error) {
                showResult('storageResult', `❌ Vika存储测试失败
错误: ${error.message}

可能的原因:
1. Token权限不足
2. 维格表ID错误
3. 网络连接问题
4. CORS跨域限制`, 'error');
            }
        }

        async function testSync() {
            showResult('storageResult', '正在测试同步功能...', 'info');
            
            try {
                // 模拟同步测试 - 获取数据然后模拟本地存储
                const response = await fetch(`${VIKA_CONFIG.apiUrl}datasheets/${VIKA_CONFIG.datasheetId}/records?viewId=${VIKA_CONFIG.viewId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${VIKA_CONFIG.token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    // 模拟保存到本地存储
                    const syncData = {
                        records: result.data.records,
                        syncTime: new Date().toISOString(),
                        source: 'Vika维格表'
                    };
                    
                    localStorage.setItem('vika_sync_test', JSON.stringify(syncData));
                    
                    showResult('storageResult', `✅ 同步测试完成！
同步结果: 成功
同步记录数: ${result.data.records.length}
同步时间: ${syncData.syncTime}
本地存储: 已保存

这模拟了从Vika维格表同步数据到本地存储的过程`, 'success');
                } else {
                    throw new Error(`同步失败: ${JSON.stringify(result)}`);
                }
            } catch (error) {
                showResult('storageResult', `❌ 同步测试失败
错误: ${error.message}

可能的原因:
1. 网络连接问题
2. API权限不足
3. 维格表配置错误`, 'error');
            }
        }

        // 添加调试功能
        function debugTest() {
            console.log('🔧 调试测试被点击');
            showResult('connectionResult', `🔧 调试测试成功！
页面加载时间: ${new Date().toLocaleString()}
JavaScript运行正常: ✅
按钮点击响应: ✅
控制台输出: 请检查浏览器开发者工具控制台

如果看到这个消息，说明JavaScript正常工作`, 'success');
        }

        // 页面加载完成后自动测试连接
        window.addEventListener('load', () => {
            console.log('🚀 Vika API本地测试页面加载完成');
            
            // 添加调试按钮
            const debugButton = document.createElement('button');
            debugButton.className = 'test-button';
            debugButton.textContent = '🔧 调试测试';
            debugButton.onclick = debugTest;
            
            const firstSection = document.querySelector('.test-section');
            firstSection.insertBefore(debugButton, firstSection.querySelector('button'));
            
            setTimeout(() => {
                console.log('开始自动连接测试...');
                testVikaConnection();
            }, 1000);
        });
    </script>
</body>
</html>
