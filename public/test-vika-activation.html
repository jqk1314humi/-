<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»´æ ¼è¡¨æ¿€æ´»ç æµ‹è¯• - æ™ºèƒ½å¯¼å‘˜</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            color: #667eea;
            font-size: 1.8rem;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .status-card h3 {
            color: #495057;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .status-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
        }

        .status-value.connected {
            color: #28a745;
        }

        .status-value.disconnected {
            color: #dc3545;
        }

        .status-value.loading {
            color: #ffc107;
        }

        .activation-form {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            margin-bottom: 20px;
        }

        .activation-input {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .activation-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .code-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .code-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .code-value {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
        }

        .code-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-used {
            background: #dc3545;
            color: white;
        }

        .status-available {
            background: #28a745;
            color: white;
        }

        .log-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .log-title {
            font-size: 1.3rem;
            color: #495057;
        }

        .log-container {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #4a5568;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-timestamp {
            color: #81c784;
        }

        .log-level {
            color: #64b5f6;
        }

        .log-message {
            color: #e2e8f0;
        }

        .test-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-card {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 15px;
        }

        .info-card h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .info-value {
            color: #424242;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .success {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .initialization-success {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            border: 1px solid #4caf50;
            color: #2e7d32;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.2);
        }

        .initialization-success h3 {
            margin-bottom: 10px;
            color: #2e7d32;
        }

        .initialization-success p {
            margin: 0;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-vial"></i> ç»´æ ¼è¡¨æ¿€æ´»ç æµ‹è¯•ç³»ç»Ÿ</h1>
            <p>æµ‹è¯•æ¿€æ´»ç ä½¿ç”¨åsituationå­—æ®µå†™å…¥åŠŸèƒ½</p>
        </div>

        <!-- åˆå§‹åŒ–æˆåŠŸæ¶ˆæ¯ -->
        <div id="initializationSuccess" class="initialization-success" style="display: none;">
            <h3><i class="fas fa-check-circle"></i> ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ</h3>
            <p>ç»´æ ¼è¡¨æ¿€æ´»ç æµ‹è¯•ç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªï¼Œæ‚¨å¯ä»¥å¼€å§‹æµ‹è¯•å„é¡¹åŠŸèƒ½ã€‚</p>
        </div>

        <div class="content">
            <!-- è¿æ¥çŠ¶æ€ -->
            <div class="section">
                <h2><i class="fas fa-wifi"></i> è¿æ¥çŠ¶æ€</h2>
                <div class="status-grid">
                    <div class="status-card">
                        <h3>ç»´æ ¼è¡¨è¿æ¥çŠ¶æ€</h3>
                        <div class="status-value loading" id="vikaStatus">æ£€æµ‹ä¸­...</div>
                    </div>
                    <div class="status-card">
                        <h3>æœ¬åœ°å­˜å‚¨çŠ¶æ€</h3>
                        <div class="status-value loading" id="localStatus">æ£€æµ‹ä¸­...</div>
                    </div>
                    <div class="status-card">
                        <h3>æ¿€æ´»ç æ€»æ•°</h3>
                        <div class="status-value loading" id="totalCodes">-</div>
                    </div>
                    <div class="status-card">
                        <h3>å·²ç”¨æ¿€æ´»ç </h3>
                        <div class="status-value loading" id="usedCodes">-</div>
                    </div>
                </div>
            </div>

            <!-- æ¿€æ´»ç åˆ—è¡¨ -->
            <div class="section">
                <h2><i class="fas fa-key"></i> æ¿€æ´»ç çŠ¶æ€</h2>
                <div class="activation-form">
                    <input type="text" class="activation-input" id="testCodeInput" placeholder="è¾“å…¥è¦æµ‹è¯•çš„æ¿€æ´»ç ">
                    <button class="btn btn-primary" id="testActivationBtn">
                        <i class="fas fa-play"></i> æµ‹è¯•æ¿€æ´»
                    </button>
                </div>
                <div class="activation-form">
                    <input type="text" class="activation-input" id="resetCodeInput" placeholder="è¾“å…¥è¦é‡ç½®çš„æ¿€æ´»ç ">
                    <button class="btn btn-secondary" id="resetActivationBtn">
                        <i class="fas fa-undo"></i> é‡ç½®æ¿€æ´»ç 
                    </button>
                </div>
                <button class="btn btn-secondary" id="refreshCodesBtn" style="margin-top: 15px;">
                    <i class="fas fa-sync"></i> åˆ·æ–°æ¿€æ´»ç åˆ—è¡¨
                </button>
                <div id="codesContainer" class="code-grid" style="display: none;">
                    <!-- æ¿€æ´»ç å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- æµ‹è¯•æ“ä½œ -->
            <div class="section">
                <h2><i class="fas fa-flask"></i> æµ‹è¯•æ“ä½œ</h2>
                <div class="test-actions">
                    <button class="btn btn-primary" id="testConnectionBtn">
                        <i class="fas fa-wifi"></i> æµ‹è¯•ç»´æ ¼è¡¨è¿æ¥
                    </button>
                    <button class="btn btn-primary" id="testLocalStorageBtn">
                        <i class="fas fa-database"></i> æµ‹è¯•æœ¬åœ°å­˜å‚¨
                    </button>
                    <button class="btn btn-primary" id="testActivationFlowBtn">
                        <i class="fas fa-cogs"></i> æµ‹è¯•å®Œæ•´æ¿€æ´»æµç¨‹
                    </button>
                    <button class="btn btn-secondary" id="clearLogsBtn">
                        <i class="fas fa-trash"></i> æ¸…ç©ºæ—¥å¿—
                    </button>
                </div>
            </div>

            <!-- ç³»ç»Ÿä¿¡æ¯ -->
            <div class="section">
                <h2><i class="fas fa-info-circle"></i> ç³»ç»Ÿä¿¡æ¯</h2>
                <div class="info-grid">
                    <div class="info-card">
                        <h4>æµè§ˆå™¨ä¿¡æ¯</h4>
                        <div class="info-value" id="browserInfo">åŠ è½½ä¸­...</div>
                    </div>
                    <div class="info-card">
                        <h4>è®¾å¤‡æŒ‡çº¹</h4>
                        <div class="info-value" id="deviceFingerprint">åŠ è½½ä¸­...</div>
                    </div>
                    <div class="info-card">
                        <h4>ç½‘ç»œçŠ¶æ€</h4>
                        <div class="info-value" id="networkStatus">åŠ è½½ä¸­...</div>
                    </div>
                    <div class="info-card">
                        <h4>æœ¬åœ°æ—¶é—´</h4>
                        <div class="info-value" id="currentTime">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>

            <!-- å®æ—¶æ—¥å¿— -->
            <div class="section">
                <div class="log-header">
                    <h2 class="log-title"><i class="fas fa-terminal"></i> å®æ—¶æ—¥å¿—</h2>
                    <div>
                        <button class="btn btn-secondary" id="pauseLogsBtn">æš‚åœ</button>
                        <button class="btn btn-secondary" id="autoScrollBtn">è‡ªåŠ¨æ»šåŠ¨</button>
                    </div>
                </div>
                <div class="log-section">
                    <div class="log-container" id="logContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class VikaTestSystem {
            constructor() {
                this.vikaStorage = null;
                this.isInitialized = false;
                this.logs = [];
                this.autoScroll = true;
                this.logsPaused = false;

                this.init();
            }

            async init() {
                try {
                    this.log('ğŸš€ ç»´æ ¼è¡¨æµ‹è¯•ç³»ç»Ÿåˆå§‹åŒ–å¼€å§‹...', 'info');

                    // æ›´æ–°ç³»ç»Ÿä¿¡æ¯
                    this.updateSystemInfo();

                    // ç­‰å¾…ç»´æ ¼è¡¨å­˜å‚¨åˆå§‹åŒ–ï¼ˆå¢åŠ è¶…æ—¶ï¼‰
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('åˆå§‹åŒ–è¶…æ—¶')), 10000);
                    });

                    await Promise.race([
                        this.waitForVikaStorage(),
                        timeoutPromise
                    ]);

                    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                    this.setupEventListeners();

                    // åˆå§‹çŠ¶æ€æ›´æ–°
                    await this.updateStatus();
                    await this.refreshActivationCodes();

                    this.isInitialized = true;
                    this.log('âœ… ç»´æ ¼è¡¨æµ‹è¯•ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'success');

                    // æ˜¾ç¤ºåˆå§‹åŒ–æˆåŠŸæ¶ˆæ¯
                    this.showInitializationSuccess();

                } catch (error) {
                    this.log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                    console.error('åˆå§‹åŒ–é”™è¯¯è¯¦æƒ…:', error);
                }
            }

            async waitForVikaStorage() {
                return new Promise((resolve, reject) => {
                    // æ£€æŸ¥vikaCloudStorageæ˜¯å¦å·²åŠ è½½å¹¶åˆå§‹åŒ–
                    if (typeof window.vikaCloudStorage !== 'undefined' && window.vikaCloudStorage) {
                        this.vikaStorage = window.vikaCloudStorage;
                        this.log('ğŸ“¦ ç»´æ ¼è¡¨äº‘å­˜å‚¨å·²å°±ç»ª', 'success');
                        resolve();
                        return;
                    }

                    this.log('â³ ç­‰å¾…ç»´æ ¼è¡¨äº‘å­˜å‚¨åˆå§‹åŒ–...', 'info');

                    // ç›‘å¬åˆå§‹åŒ–äº‹ä»¶
                    const checkInitialization = () => {
                        if (typeof window.vikaCloudStorage !== 'undefined' && window.vikaCloudStorage) {
                            this.vikaStorage = window.vikaCloudStorage;
                            this.log('ğŸ“¦ ç»´æ ¼è¡¨äº‘å­˜å‚¨å·²å°±ç»ª', 'success');
                            window.removeEventListener('vikaStorageReady', checkInitialization);
                            resolve();
                        }
                    };

                    window.addEventListener('vikaStorageReady', checkInitialization);

                    // å®šæœŸæ£€æŸ¥ï¼ˆæ¯100msæ£€æŸ¥ä¸€æ¬¡ï¼‰
                    const interval = setInterval(() => {
                        if (typeof window.vikaCloudStorage !== 'undefined' && window.vikaCloudStorage) {
                            this.vikaStorage = window.vikaCloudStorage;
                            this.log('ğŸ“¦ ç»´æ ¼è¡¨äº‘å­˜å‚¨å·²å°±ç»ª', 'success');
                            clearInterval(interval);
                            window.removeEventListener('vikaStorageReady', checkInitialization);
                            resolve();
                        }
                    }, 100);

                    // 10ç§’åè¶…æ—¶
                    setTimeout(() => {
                        clearInterval(interval);
                        window.removeEventListener('vikaStorageReady', checkInitialization);
                        reject(new Error('ç»´æ ¼è¡¨äº‘å­˜å‚¨åˆå§‹åŒ–è¶…æ—¶'));
                    }, 10000);
                });
            }

            setupEventListeners() {
                // æµ‹è¯•è¿æ¥æŒ‰é’®
                document.getElementById('testConnectionBtn').addEventListener('click', async () => {
                    await this.testVikaConnection();
                });

                // æµ‹è¯•æœ¬åœ°å­˜å‚¨æŒ‰é’®
                document.getElementById('testLocalStorageBtn').addEventListener('click', async () => {
                    await this.testLocalStorage();
                });

                // æµ‹è¯•æ¿€æ´»æµç¨‹æŒ‰é’®
                document.getElementById('testActivationFlowBtn').addEventListener('click', async () => {
                    await this.testActivationFlow();
                });

                // æµ‹è¯•æ¿€æ´»æŒ‰é’®
                document.getElementById('testActivationBtn').addEventListener('click', async () => {
                    await this.testActivation();
                });

                // é‡ç½®æ¿€æ´»ç æŒ‰é’®
                document.getElementById('resetActivationBtn').addEventListener('click', async () => {
                    await this.resetActivation();
                });

                // åˆ·æ–°æ¿€æ´»ç åˆ—è¡¨æŒ‰é’®
                document.getElementById('refreshCodesBtn').addEventListener('click', async () => {
                    await this.refreshActivationCodes();
                });

                // æ¸…ç©ºæ—¥å¿—æŒ‰é’®
                document.getElementById('clearLogsBtn').addEventListener('click', () => {
                    this.clearLogs();
                });

                // æš‚åœæ—¥å¿—æŒ‰é’®
                document.getElementById('pauseLogsBtn').addEventListener('click', () => {
                    this.toggleLogsPause();
                });

                // è‡ªåŠ¨æ»šåŠ¨æŒ‰é’®
                document.getElementById('autoScrollBtn').addEventListener('click', () => {
                    this.toggleAutoScroll();
                });

                // å®šæœŸæ›´æ–°çŠ¶æ€
                setInterval(() => {
                    if (this.isInitialized) {
                        this.updateStatus();
                    }
                }, 2000);
            }

            async testVikaConnection() {
                const btn = document.getElementById('testConnectionBtn');
                const originalText = btn.innerHTML;

                try {
                    this.log('ğŸ” æµ‹è¯•ç»´æ ¼è¡¨è¿æ¥...', 'info');

                    // è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æµ‹è¯•ä¸­...';

                    if (!this.vikaStorage || !this.vikaStorage.isInitialized) {
                        throw new Error('ç»´æ ¼è¡¨å­˜å‚¨æœªåˆå§‹åŒ–');
                    }

                    // æµ‹è¯•åŸºæœ¬è¿æ¥
                    const connectionStatus = this.vikaStorage.getConnectionStatus();
                    this.log(`ğŸ“Š è¿æ¥çŠ¶æ€: ${JSON.stringify(connectionStatus)}`, 'info');

                    // æµ‹è¯•è·å–è®°å½•
                    const records = await this.vikaStorage.getRecords();
                    this.log(`ğŸ“ è·å–åˆ° ${records.length} æ¡è®°å½•`, 'success');

                    this.log('âœ… ç»´æ ¼è¡¨è¿æ¥æµ‹è¯•é€šè¿‡', 'success');

                } catch (error) {
                    this.log(`âŒ ç»´æ ¼è¡¨è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async testLocalStorage() {
                const btn = document.getElementById('testLocalStorageBtn');
                const originalText = btn.innerHTML;

                try {
                    this.log('ğŸ’¾ æµ‹è¯•æœ¬åœ°å­˜å‚¨...', 'info');

                    // è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æµ‹è¯•ä¸­...';

                    // æµ‹è¯•è·å–æœ¬åœ°æ¿€æ´»ç 
                    const localCodes = this.getLocalActivationCodes();
                    const codeCount = Object.keys(localCodes).length;
                    this.log(`ğŸ“ æœ¬åœ°æ¿€æ´»ç æ•°é‡: ${codeCount}`, 'info');

                    // æ˜¾ç¤ºå‰å‡ ä¸ªæ¿€æ´»ç 
                    const codesToShow = Object.entries(localCodes).slice(0, 3);
                    codesToShow.forEach(([code, data]) => {
                        this.log(`ğŸ”‘ ${code}: situation=${data.situation}, isUsed=${data.isUsed}`, 'info');
                    });

                    this.log('âœ… æœ¬åœ°å­˜å‚¨æµ‹è¯•é€šè¿‡', 'success');

                } catch (error) {
                    this.log(`âŒ æœ¬åœ°å­˜å‚¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async testActivationFlow() {
                const btn = document.getElementById('testActivationFlowBtn');
                const originalText = btn.innerHTML;

                try {
                    this.log('ğŸ”„ æµ‹è¯•å®Œæ•´æ¿€æ´»æµç¨‹...', 'info');

                    // è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æµ‹è¯•ä¸­...';

                    // è·å–å½“å‰æ¿€æ´»ç çŠ¶æ€
                    await this.refreshActivationCodes();

                    // é€‰æ‹©ç¬¬ä¸€ä¸ªæœªä½¿ç”¨çš„æ¿€æ´»ç è¿›è¡Œæµ‹è¯•
                    const codes = this.getLocalActivationCodes();
                    const availableCode = Object.entries(codes).find(([code, data]) => !data.isUsed);

                    if (!availableCode) {
                        this.log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„æ¿€æ´»ç è¿›è¡Œæµ‹è¯•', 'warning');
                        return;
                    }

                    const [testCode] = availableCode;
                    this.log(`ğŸ¯ é€‰æ‹©æ¿€æ´»ç è¿›è¡Œæµ‹è¯•: ${testCode}`, 'info');

                    // æ¨¡æ‹Ÿæ¿€æ´»æµç¨‹
                    await this.simulateActivation(testCode);

                } catch (error) {
                    this.log(`âŒ æ¿€æ´»æµç¨‹æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async testActivation() {
                const codeInput = document.getElementById('testCodeInput');
                const btn = document.getElementById('testActivationBtn');
                const originalText = btn.innerHTML;
                const code = codeInput.value.trim();

                if (!code) {
                    this.log('âŒ è¯·è¾“å…¥æ¿€æ´»ç ', 'error');
                    return;
                }

                try {
                    this.log(`ğŸ”‘ å¼€å§‹æµ‹è¯•æ¿€æ´»ç : ${code}`, 'info');

                    // è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æµ‹è¯•ä¸­...';

                    await this.simulateActivation(code);

                } catch (error) {
                    this.log(`âŒ æ¿€æ´»æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async resetActivation() {
                const codeInput = document.getElementById('resetCodeInput');
                const btn = document.getElementById('resetActivationBtn');
                const originalText = btn.innerHTML;
                const code = codeInput.value.trim();

                if (!code) {
                    this.log('âŒ è¯·è¾“å…¥è¦é‡ç½®çš„æ¿€æ´»ç ', 'error');
                    return;
                }

                try {
                    this.log(`ğŸ”„ å¼€å§‹é‡ç½®æ¿€æ´»ç : ${code}`, 'info');

                    // è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> é‡ç½®ä¸­...';

                    if (this.vikaStorage && this.vikaStorage.isInitialized) {
                        const result = await this.vikaStorage.resetActivationCode(code);
                        this.log(`ğŸ“ ç»´æ ¼è¡¨é‡ç½®ç»“æœ: ${JSON.stringify(result)}`, 'info');
                    }

                    // åˆ·æ–°æ˜¾ç¤º
                    await this.refreshActivationCodes();
                    this.log('âœ… æ¿€æ´»ç é‡ç½®å®Œæˆ', 'success');

                } catch (error) {
                    this.log(`âŒ æ¿€æ´»ç é‡ç½®å¤±è´¥: ${error.message}`, 'error');
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async simulateActivation(code) {
                try {
                    const deviceInfo = {
                        deviceId: this.generateDeviceFingerprint(),
                        userAgent: navigator.userAgent,
                        timestamp: new Date().toISOString(),
                        platform: navigator.platform,
                        language: navigator.language
                    };

                    this.log(`ğŸ“ è®¾å¤‡ä¿¡æ¯: ${JSON.stringify(deviceInfo)}`, 'info');

                    // è®°å½•æ¿€æ´»å‰çŠ¶æ€
                    const codesBefore = await this.vikaStorage.getActivationCodes();
                    const codeInfoBefore = codesBefore[code];
                    this.log(`ğŸ“Š æ¿€æ´»å‰çŠ¶æ€ - situation: ${codeInfoBefore?.situation}, isUsed: ${codeInfoBefore?.isUsed}`, 'info');

                    // æ‰§è¡Œæ¿€æ´»
                    const result = await this.vikaStorage.useActivationCode(code, deviceInfo);
                    this.log(`ğŸ“ æ¿€æ´»ç»“æœ: ${JSON.stringify(result)}`, 'info');

                    // è®°å½•æ¿€æ´»åçŠ¶æ€
                    const codesAfter = await this.vikaStorage.getActivationCodes();
                    const codeInfoAfter = codesAfter[code];
                    this.log(`ğŸ“Š æ¿€æ´»åçŠ¶æ€ - situation: ${codeInfoAfter?.situation}, isUsed: ${codeInfoAfter?.isUsed}`, 'info');

                    // éªŒè¯situationå­—æ®µæ˜¯å¦æ­£ç¡®æ›´æ–°ä¸º2
                    if (codeInfoAfter && codeInfoAfter.situation === 2) {
                        this.log('âœ… situationå­—æ®µæ­£ç¡®æ›´æ–°ä¸º2', 'success');
                    } else {
                        this.log('âŒ situationå­—æ®µæ›´æ–°å¤±è´¥', 'error');
                    }

                    // åˆ·æ–°æ˜¾ç¤º
                    await this.refreshActivationCodes();

                } catch (error) {
                    this.log(`âŒ æ¨¡æ‹Ÿæ¿€æ´»å¤±è´¥: ${error.message}`, 'error');
                    throw error;
                }
            }

            async refreshActivationCodes() {
                const btn = document.getElementById('refreshCodesBtn');
                const originalText = btn.innerHTML;

                try {
                    this.log('ğŸ”„ åˆ·æ–°æ¿€æ´»ç åˆ—è¡¨...', 'info');

                    // è®¾ç½®æŒ‰é’®åŠ è½½çŠ¶æ€
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åˆ·æ–°ä¸­...';

                    let codes = {};

                    if (this.vikaStorage && this.vikaStorage.isInitialized) {
                        codes = await this.vikaStorage.getActivationCodes();
                        this.log('ğŸ“¡ ä»ç»´æ ¼è¡¨è·å–æ¿€æ´»ç ', 'info');
                    } else {
                        codes = this.getLocalActivationCodes();
                        this.log('ğŸ’¾ ä»æœ¬åœ°å­˜å‚¨è·å–æ¿€æ´»ç ', 'info');
                    }

                    this.displayActivationCodes(codes);
                    this.updateStatus();

                } catch (error) {
                    this.log(`âŒ åˆ·æ–°æ¿€æ´»ç åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            displayActivationCodes(codes) {
                const container = document.getElementById('codesContainer');
                const codeEntries = Object.entries(codes);

                if (codeEntries.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">æš‚æ— æ¿€æ´»ç æ•°æ®</p>';
                    container.style.display = 'block';
                    return;
                }

                container.innerHTML = '';

                codeEntries.forEach(([code, data]) => {
                    const card = document.createElement('div');
                    card.className = 'code-card';

                    const statusClass = data.isUsed ? 'status-used' : 'status-available';
                    const statusText = data.isUsed ? 'å·²ä½¿ç”¨' : 'å¯ç”¨';

                    card.innerHTML = `
                        <div class="code-value">${code}</div>
                        <div class="code-status ${statusClass}">${statusText}</div>
                        <div style="font-size: 0.85rem; color: #666; margin-top: 8px;">
                            situation: ${data.situation || 'æœªè®¾ç½®'} |
                            åˆ›å»ºæ—¶é—´: ${data.createdAt ? new Date(data.createdAt).toLocaleString() : 'æœªçŸ¥'}
                        </div>
                    `;

                    container.appendChild(card);
                });

                container.style.display = 'grid';
            }

            getLocalActivationCodes() {
                try {
                    const codes = localStorage.getItem('activationCodes');
                    return codes ? JSON.parse(codes) : {};
                } catch (error) {
                    this.log(`âŒ è¯»å–æœ¬åœ°æ¿€æ´»ç å¤±è´¥: ${error.message}`, 'error');
                    return {};
                }
            }

            generateDeviceFingerprint() {
                const components = [
                    navigator.userAgent,
                    navigator.language,
                    navigator.platform,
                    screen.width + 'x' + screen.height,
                    screen.colorDepth,
                    new Date().getTimezoneOffset(),
                    navigator.hardwareConcurrency || 'unknown',
                    navigator.deviceMemory || 'unknown'
                ];

                if (navigator.plugins) {
                    components.push(Array.from(navigator.plugins).map(p => p.name).join(','));
                }

                const fingerprint = this.hashString(components.join('|'));
                return fingerprint.substring(0, 16);
            }

            hashString(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(16);
            }

            updateSystemInfo() {
                // æµè§ˆå™¨ä¿¡æ¯
                document.getElementById('browserInfo').textContent = navigator.userAgent;

                // è®¾å¤‡æŒ‡çº¹
                const fingerprint = this.generateDeviceFingerprint();
                document.getElementById('deviceFingerprint').textContent = fingerprint;

                // ç½‘ç»œçŠ¶æ€
                document.getElementById('networkStatus').textContent =
                    navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿';

                // å½“å‰æ—¶é—´
                const updateTime = () => {
                    document.getElementById('currentTime').textContent =
                        new Date().toLocaleString('zh-CN');
                };
                updateTime();
                setInterval(updateTime, 1000);
            }

            async updateStatus() {
                try {
                    let codes = {};

                    if (this.vikaStorage && this.vikaStorage.isInitialized) {
                        codes = await this.vikaStorage.getActivationCodes();
                        document.getElementById('vikaStatus').textContent = 'å·²è¿æ¥';
                        document.getElementById('vikaStatus').className = 'status-value connected';
                    } else {
                        document.getElementById('vikaStatus').textContent = 'æœªè¿æ¥';
                        document.getElementById('vikaStatus').className = 'status-value disconnected';
                    }

                    const localCodes = this.getLocalActivationCodes();
                    const totalCodes = Object.keys(codes).length || Object.keys(localCodes).length;
                    const usedCodes = Object.values(codes).filter(code => code.isUsed).length ||
                                    Object.values(localCodes).filter(code => code.isUsed).length;

                    document.getElementById('localStatus').textContent = 'æ­£å¸¸';
                    document.getElementById('localStatus').className = 'status-value connected';
                    document.getElementById('totalCodes').textContent = totalCodes;
                    document.getElementById('usedCodes').textContent = usedCodes;

                } catch (error) {
                    document.getElementById('vikaStatus').textContent = 'é”™è¯¯';
                    document.getElementById('vikaStatus').className = 'status-value disconnected';
                    document.getElementById('localStatus').textContent = 'é”™è¯¯';
                    document.getElementById('localStatus').className = 'status-value disconnected';
                }
            }

            log(message, level = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = {
                    timestamp,
                    level,
                    message
                };

                this.logs.unshift(logEntry);

                // é™åˆ¶æ—¥å¿—æ•°é‡
                if (this.logs.length > 1000) {
                    this.logs.splice(1000);
                }

                this.updateLogDisplay();
            }

            updateLogDisplay() {
                if (this.logsPaused) return;

                const container = document.getElementById('logContainer');
                container.innerHTML = '';

                this.logs.forEach(log => {
                    const entry = document.createElement('div');
                    entry.className = 'log-entry';

                    entry.innerHTML = `
                        <span class="log-timestamp">[${log.timestamp}]</span>
                        <span class="log-level">[${log.level.toUpperCase()}]</span>
                        <span class="log-message">${log.message}</span>
                    `;

                    container.appendChild(entry);
                });

                if (this.autoScroll) {
                    container.scrollTop = container.scrollHeight;
                }
            }

            clearLogs() {
                this.logs = [];
                this.updateLogDisplay();
                this.log('ğŸ§¹ æ—¥å¿—å·²æ¸…ç©º', 'info');
            }

            toggleLogsPause() {
                this.logsPaused = !this.logsPaused;
                const btn = document.getElementById('pauseLogsBtn');
                btn.textContent = this.logsPaused ? 'ç»§ç»­' : 'æš‚åœ';

                if (!this.logsPaused) {
                    this.updateLogDisplay();
                }

                this.log(`æ—¥å¿—${this.logsPaused ? 'æš‚åœ' : 'ç»§ç»­'}`, 'info');
            }

            toggleAutoScroll() {
                this.autoScroll = !this.autoScroll;
                const btn = document.getElementById('autoScrollBtn');
                btn.textContent = this.autoScroll ? 'è‡ªåŠ¨æ»šåŠ¨' : 'åœæ­¢æ»šåŠ¨';

                if (this.autoScroll) {
                    const container = document.getElementById('logContainer');
                    container.scrollTop = container.scrollHeight;
                }

                this.log(`è‡ªåŠ¨æ»šåŠ¨${this.autoScroll ? 'å¼€å¯' : 'å…³é—­'}`, 'info');
            }

            showInitializationSuccess() {
                const successDiv = document.getElementById('initializationSuccess');
                if (successDiv) {
                    successDiv.style.display = 'block';

                    // 3ç§’åè‡ªåŠ¨éšè—
                    setTimeout(() => {
                        successDiv.style.display = 'none';
                    }, 3000);
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æµ‹è¯•ç³»ç»Ÿ
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ§ª ç»´æ ¼è¡¨æ¿€æ´»ç æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            window.vikaTestSystem = new VikaTestSystem();
        });
    </script>
</body>
</html>
