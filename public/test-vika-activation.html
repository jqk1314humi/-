<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>维格表激活码测试 - 智能导员</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            color: #667eea;
            font-size: 1.8rem;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .status-card h3 {
            color: #495057;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .status-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #007bff;
        }

        .status-value.connected {
            color: #28a745;
        }

        .status-value.disconnected {
            color: #dc3545;
        }

        .status-value.loading {
            color: #ffc107;
        }

        .activation-form {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            margin-bottom: 20px;
        }

        .activation-input {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .activation-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .code-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .code-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .code-value {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
        }

        .code-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-used {
            background: #dc3545;
            color: white;
        }

        .status-available {
            background: #28a745;
            color: white;
        }

        .log-section {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .log-title {
            font-size: 1.3rem;
            color: #495057;
        }

        .log-container {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 4px 0;
            border-bottom: 1px solid #4a5568;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-timestamp {
            color: #81c784;
        }

        .log-level {
            color: #64b5f6;
        }

        .log-message {
            color: #e2e8f0;
        }

        .test-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-card {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 15px;
        }

        .info-card h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .info-value {
            color: #424242;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .success {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .initialization-success {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
            border: 1px solid #4caf50;
            color: #2e7d32;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.2);
        }

        .initialization-success h3 {
            margin-bottom: 10px;
            color: #2e7d32;
        }

        .initialization-success p {
            margin: 0;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-vial"></i> 维格表激活码测试系统</h1>
            <p>测试激活码使用后situation字段写入功能</p>
        </div>

        <!-- 初始化成功消息 -->
        <div id="initializationSuccess" class="initialization-success" style="display: none;">
            <h3><i class="fas fa-check-circle"></i> 系统初始化成功</h3>
            <p>维格表激活码测试系统已准备就绪，您可以开始测试各项功能。</p>
        </div>

        <div class="content">
            <!-- 连接状态 -->
            <div class="section">
                <h2><i class="fas fa-wifi"></i> 连接状态</h2>
                <div class="status-grid">
                    <div class="status-card">
                        <h3>维格表连接状态</h3>
                        <div class="status-value loading" id="vikaStatus">检测中...</div>
                    </div>
                    <div class="status-card">
                        <h3>本地存储状态</h3>
                        <div class="status-value loading" id="localStatus">检测中...</div>
                    </div>
                    <div class="status-card">
                        <h3>激活码总数</h3>
                        <div class="status-value loading" id="totalCodes">-</div>
                    </div>
                    <div class="status-card">
                        <h3>已用激活码</h3>
                        <div class="status-value loading" id="usedCodes">-</div>
                    </div>
                </div>
            </div>

            <!-- 激活码列表 -->
            <div class="section">
                <h2><i class="fas fa-key"></i> 激活码状态</h2>
                <div class="activation-form">
                    <input type="text" class="activation-input" id="testCodeInput" placeholder="输入要测试的激活码">
                    <button class="btn btn-primary" id="testActivationBtn">
                        <i class="fas fa-play"></i> 测试激活
                    </button>
                </div>
                <div class="activation-form">
                    <input type="text" class="activation-input" id="resetCodeInput" placeholder="输入要重置的激活码">
                    <button class="btn btn-secondary" id="resetActivationBtn">
                        <i class="fas fa-undo"></i> 重置激活码
                    </button>
                </div>
                <button class="btn btn-secondary" id="refreshCodesBtn" style="margin-top: 15px;">
                    <i class="fas fa-sync"></i> 刷新激活码列表
                </button>
                <div id="codesContainer" class="code-grid" style="display: none;">
                    <!-- 激活码卡片将在这里动态生成 -->
                </div>
            </div>

            <!-- 测试操作 -->
            <div class="section">
                <h2><i class="fas fa-flask"></i> 测试操作</h2>
                <div class="test-actions">
                    <button class="btn btn-primary" id="testConnectionBtn">
                        <i class="fas fa-wifi"></i> 测试维格表连接
                    </button>
                    <button class="btn btn-primary" id="testLocalStorageBtn">
                        <i class="fas fa-database"></i> 测试本地存储
                    </button>
                    <button class="btn btn-primary" id="testActivationFlowBtn">
                        <i class="fas fa-cogs"></i> 测试完整激活流程
                    </button>
                    <button class="btn btn-secondary" id="clearLogsBtn">
                        <i class="fas fa-trash"></i> 清空日志
                    </button>
                </div>
            </div>

            <!-- 系统信息 -->
            <div class="section">
                <h2><i class="fas fa-info-circle"></i> 系统信息</h2>
                <div class="info-grid">
                    <div class="info-card">
                        <h4>浏览器信息</h4>
                        <div class="info-value" id="browserInfo">加载中...</div>
                    </div>
                    <div class="info-card">
                        <h4>设备指纹</h4>
                        <div class="info-value" id="deviceFingerprint">加载中...</div>
                    </div>
                    <div class="info-card">
                        <h4>网络状态</h4>
                        <div class="info-value" id="networkStatus">加载中...</div>
                    </div>
                    <div class="info-card">
                        <h4>本地时间</h4>
                        <div class="info-value" id="currentTime">加载中...</div>
                    </div>
                </div>
            </div>

            <!-- 实时日志 -->
            <div class="section">
                <div class="log-header">
                    <h2 class="log-title"><i class="fas fa-terminal"></i> 实时日志</h2>
                    <div>
                        <button class="btn btn-secondary" id="pauseLogsBtn">暂停</button>
                        <button class="btn btn-secondary" id="autoScrollBtn">自动滚动</button>
                    </div>
                </div>
                <div class="log-section">
                    <div class="log-container" id="logContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class VikaTestSystem {
            constructor() {
                this.vikaStorage = null;
                this.isInitialized = false;
                this.logs = [];
                this.autoScroll = true;
                this.logsPaused = false;

                this.init();
            }

            async init() {
                try {
                    this.log('🚀 维格表测试系统初始化开始...', 'info');

                    // 更新系统信息
                    this.updateSystemInfo();

                    // 等待维格表存储初始化（增加超时）
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('初始化超时')), 10000);
                    });

                    await Promise.race([
                        this.waitForVikaStorage(),
                        timeoutPromise
                    ]);

                    // 设置事件监听器
                    this.setupEventListeners();

                    // 初始状态更新
                    await this.updateStatus();
                    await this.refreshActivationCodes();

                    this.isInitialized = true;
                    this.log('✅ 维格表测试系统初始化完成', 'success');

                    // 显示初始化成功消息
                    this.showInitializationSuccess();

                } catch (error) {
                    this.log(`❌ 初始化失败: ${error.message}`, 'error');
                    console.error('初始化错误详情:', error);
                }
            }

            async waitForVikaStorage() {
                return new Promise((resolve, reject) => {
                    // 检查vikaCloudStorage是否已加载并初始化
                    if (typeof window.vikaCloudStorage !== 'undefined' && window.vikaCloudStorage) {
                        this.vikaStorage = window.vikaCloudStorage;
                        this.log('📦 维格表云存储已就绪', 'success');
                        resolve();
                        return;
                    }

                    this.log('⏳ 等待维格表云存储初始化...', 'info');

                    // 监听初始化事件
                    const checkInitialization = () => {
                        if (typeof window.vikaCloudStorage !== 'undefined' && window.vikaCloudStorage) {
                            this.vikaStorage = window.vikaCloudStorage;
                            this.log('📦 维格表云存储已就绪', 'success');
                            window.removeEventListener('vikaStorageReady', checkInitialization);
                            resolve();
                        }
                    };

                    window.addEventListener('vikaStorageReady', checkInitialization);

                    // 定期检查（每100ms检查一次）
                    const interval = setInterval(() => {
                        if (typeof window.vikaCloudStorage !== 'undefined' && window.vikaCloudStorage) {
                            this.vikaStorage = window.vikaCloudStorage;
                            this.log('📦 维格表云存储已就绪', 'success');
                            clearInterval(interval);
                            window.removeEventListener('vikaStorageReady', checkInitialization);
                            resolve();
                        }
                    }, 100);

                    // 10秒后超时
                    setTimeout(() => {
                        clearInterval(interval);
                        window.removeEventListener('vikaStorageReady', checkInitialization);
                        reject(new Error('维格表云存储初始化超时'));
                    }, 10000);
                });
            }

            setupEventListeners() {
                // 测试连接按钮
                document.getElementById('testConnectionBtn').addEventListener('click', async () => {
                    await this.testVikaConnection();
                });

                // 测试本地存储按钮
                document.getElementById('testLocalStorageBtn').addEventListener('click', async () => {
                    await this.testLocalStorage();
                });

                // 测试激活流程按钮
                document.getElementById('testActivationFlowBtn').addEventListener('click', async () => {
                    await this.testActivationFlow();
                });

                // 测试激活按钮
                document.getElementById('testActivationBtn').addEventListener('click', async () => {
                    await this.testActivation();
                });

                // 重置激活码按钮
                document.getElementById('resetActivationBtn').addEventListener('click', async () => {
                    await this.resetActivation();
                });

                // 刷新激活码列表按钮
                document.getElementById('refreshCodesBtn').addEventListener('click', async () => {
                    await this.refreshActivationCodes();
                });

                // 清空日志按钮
                document.getElementById('clearLogsBtn').addEventListener('click', () => {
                    this.clearLogs();
                });

                // 暂停日志按钮
                document.getElementById('pauseLogsBtn').addEventListener('click', () => {
                    this.toggleLogsPause();
                });

                // 自动滚动按钮
                document.getElementById('autoScrollBtn').addEventListener('click', () => {
                    this.toggleAutoScroll();
                });

                // 定期更新状态
                setInterval(() => {
                    if (this.isInitialized) {
                        this.updateStatus();
                    }
                }, 2000);
            }

            async testVikaConnection() {
                const btn = document.getElementById('testConnectionBtn');
                const originalText = btn.innerHTML;

                try {
                    this.log('🔍 测试维格表连接...', 'info');

                    // 设置按钮加载状态
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 测试中...';

                    if (!this.vikaStorage || !this.vikaStorage.isInitialized) {
                        throw new Error('维格表存储未初始化');
                    }

                    // 测试基本连接
                    const connectionStatus = this.vikaStorage.getConnectionStatus();
                    this.log(`📊 连接状态: ${JSON.stringify(connectionStatus)}`, 'info');

                    // 测试获取记录
                    const records = await this.vikaStorage.getRecords();
                    this.log(`📝 获取到 ${records.length} 条记录`, 'success');

                    this.log('✅ 维格表连接测试通过', 'success');

                } catch (error) {
                    this.log(`❌ 维格表连接测试失败: ${error.message}`, 'error');
                } finally {
                    // 恢复按钮状态
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async testLocalStorage() {
                const btn = document.getElementById('testLocalStorageBtn');
                const originalText = btn.innerHTML;

                try {
                    this.log('💾 测试本地存储...', 'info');

                    // 设置按钮加载状态
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 测试中...';

                    // 测试获取本地激活码
                    const localCodes = this.getLocalActivationCodes();
                    const codeCount = Object.keys(localCodes).length;
                    this.log(`📝 本地激活码数量: ${codeCount}`, 'info');

                    // 显示前几个激活码
                    const codesToShow = Object.entries(localCodes).slice(0, 3);
                    codesToShow.forEach(([code, data]) => {
                        this.log(`🔑 ${code}: situation=${data.situation}, isUsed=${data.isUsed}`, 'info');
                    });

                    this.log('✅ 本地存储测试通过', 'success');

                } catch (error) {
                    this.log(`❌ 本地存储测试失败: ${error.message}`, 'error');
                } finally {
                    // 恢复按钮状态
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async testActivationFlow() {
                const btn = document.getElementById('testActivationFlowBtn');
                const originalText = btn.innerHTML;

                try {
                    this.log('🔄 测试完整激活流程...', 'info');

                    // 设置按钮加载状态
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 测试中...';

                    // 获取当前激活码状态
                    await this.refreshActivationCodes();

                    // 选择第一个未使用的激活码进行测试
                    const codes = this.getLocalActivationCodes();
                    const availableCode = Object.entries(codes).find(([code, data]) => !data.isUsed);

                    if (!availableCode) {
                        this.log('⚠️ 没有找到可用的激活码进行测试', 'warning');
                        return;
                    }

                    const [testCode] = availableCode;
                    this.log(`🎯 选择激活码进行测试: ${testCode}`, 'info');

                    // 模拟激活流程
                    await this.simulateActivation(testCode);

                } catch (error) {
                    this.log(`❌ 激活流程测试失败: ${error.message}`, 'error');
                } finally {
                    // 恢复按钮状态
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async testActivation() {
                const codeInput = document.getElementById('testCodeInput');
                const btn = document.getElementById('testActivationBtn');
                const originalText = btn.innerHTML;
                const code = codeInput.value.trim();

                if (!code) {
                    this.log('❌ 请输入激活码', 'error');
                    return;
                }

                try {
                    this.log(`🔑 开始测试激活码: ${code}`, 'info');

                    // 设置按钮加载状态
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 测试中...';

                    await this.simulateActivation(code);

                } catch (error) {
                    this.log(`❌ 激活测试失败: ${error.message}`, 'error');
                } finally {
                    // 恢复按钮状态
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async resetActivation() {
                const codeInput = document.getElementById('resetCodeInput');
                const btn = document.getElementById('resetActivationBtn');
                const originalText = btn.innerHTML;
                const code = codeInput.value.trim();

                if (!code) {
                    this.log('❌ 请输入要重置的激活码', 'error');
                    return;
                }

                try {
                    this.log(`🔄 开始重置激活码: ${code}`, 'info');

                    // 设置按钮加载状态
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 重置中...';

                    if (this.vikaStorage && this.vikaStorage.isInitialized) {
                        const result = await this.vikaStorage.resetActivationCode(code);
                        this.log(`📝 维格表重置结果: ${JSON.stringify(result)}`, 'info');
                    }

                    // 刷新显示
                    await this.refreshActivationCodes();
                    this.log('✅ 激活码重置完成', 'success');

                } catch (error) {
                    this.log(`❌ 激活码重置失败: ${error.message}`, 'error');
                } finally {
                    // 恢复按钮状态
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            async simulateActivation(code) {
                try {
                    const deviceInfo = {
                        deviceId: this.generateDeviceFingerprint(),
                        userAgent: navigator.userAgent,
                        timestamp: new Date().toISOString(),
                        platform: navigator.platform,
                        language: navigator.language
                    };

                    this.log(`📝 设备信息: ${JSON.stringify(deviceInfo)}`, 'info');

                    // 记录激活前状态
                    const codesBefore = await this.vikaStorage.getActivationCodes();
                    const codeInfoBefore = codesBefore[code];
                    this.log(`📊 激活前状态 - situation: ${codeInfoBefore?.situation}, isUsed: ${codeInfoBefore?.isUsed}`, 'info');

                    // 执行激活
                    const result = await this.vikaStorage.useActivationCode(code, deviceInfo);
                    this.log(`📝 激活结果: ${JSON.stringify(result)}`, 'info');

                    // 记录激活后状态
                    const codesAfter = await this.vikaStorage.getActivationCodes();
                    const codeInfoAfter = codesAfter[code];
                    this.log(`📊 激活后状态 - situation: ${codeInfoAfter?.situation}, isUsed: ${codeInfoAfter?.isUsed}`, 'info');

                    // 验证situation字段是否正确更新为2
                    if (codeInfoAfter && codeInfoAfter.situation === 2) {
                        this.log('✅ situation字段正确更新为2', 'success');
                    } else {
                        this.log('❌ situation字段更新失败', 'error');
                    }

                    // 刷新显示
                    await this.refreshActivationCodes();

                } catch (error) {
                    this.log(`❌ 模拟激活失败: ${error.message}`, 'error');
                    throw error;
                }
            }

            async refreshActivationCodes() {
                const btn = document.getElementById('refreshCodesBtn');
                const originalText = btn.innerHTML;

                try {
                    this.log('🔄 刷新激活码列表...', 'info');

                    // 设置按钮加载状态
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 刷新中...';

                    let codes = {};

                    if (this.vikaStorage && this.vikaStorage.isInitialized) {
                        codes = await this.vikaStorage.getActivationCodes();
                        this.log('📡 从维格表获取激活码', 'info');
                    } else {
                        codes = this.getLocalActivationCodes();
                        this.log('💾 从本地存储获取激活码', 'info');
                    }

                    this.displayActivationCodes(codes);
                    this.updateStatus();

                } catch (error) {
                    this.log(`❌ 刷新激活码列表失败: ${error.message}`, 'error');
                } finally {
                    // 恢复按钮状态
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }

            displayActivationCodes(codes) {
                const container = document.getElementById('codesContainer');
                const codeEntries = Object.entries(codes);

                if (codeEntries.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">暂无激活码数据</p>';
                    container.style.display = 'block';
                    return;
                }

                container.innerHTML = '';

                codeEntries.forEach(([code, data]) => {
                    const card = document.createElement('div');
                    card.className = 'code-card';

                    const statusClass = data.isUsed ? 'status-used' : 'status-available';
                    const statusText = data.isUsed ? '已使用' : '可用';

                    card.innerHTML = `
                        <div class="code-value">${code}</div>
                        <div class="code-status ${statusClass}">${statusText}</div>
                        <div style="font-size: 0.85rem; color: #666; margin-top: 8px;">
                            situation: ${data.situation || '未设置'} |
                            创建时间: ${data.createdAt ? new Date(data.createdAt).toLocaleString() : '未知'}
                        </div>
                    `;

                    container.appendChild(card);
                });

                container.style.display = 'grid';
            }

            getLocalActivationCodes() {
                try {
                    const codes = localStorage.getItem('activationCodes');
                    return codes ? JSON.parse(codes) : {};
                } catch (error) {
                    this.log(`❌ 读取本地激活码失败: ${error.message}`, 'error');
                    return {};
                }
            }

            generateDeviceFingerprint() {
                const components = [
                    navigator.userAgent,
                    navigator.language,
                    navigator.platform,
                    screen.width + 'x' + screen.height,
                    screen.colorDepth,
                    new Date().getTimezoneOffset(),
                    navigator.hardwareConcurrency || 'unknown',
                    navigator.deviceMemory || 'unknown'
                ];

                if (navigator.plugins) {
                    components.push(Array.from(navigator.plugins).map(p => p.name).join(','));
                }

                const fingerprint = this.hashString(components.join('|'));
                return fingerprint.substring(0, 16);
            }

            hashString(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return Math.abs(hash).toString(16);
            }

            updateSystemInfo() {
                // 浏览器信息
                document.getElementById('browserInfo').textContent = navigator.userAgent;

                // 设备指纹
                const fingerprint = this.generateDeviceFingerprint();
                document.getElementById('deviceFingerprint').textContent = fingerprint;

                // 网络状态
                document.getElementById('networkStatus').textContent =
                    navigator.onLine ? '在线' : '离线';

                // 当前时间
                const updateTime = () => {
                    document.getElementById('currentTime').textContent =
                        new Date().toLocaleString('zh-CN');
                };
                updateTime();
                setInterval(updateTime, 1000);
            }

            async updateStatus() {
                try {
                    let codes = {};

                    if (this.vikaStorage && this.vikaStorage.isInitialized) {
                        codes = await this.vikaStorage.getActivationCodes();
                        document.getElementById('vikaStatus').textContent = '已连接';
                        document.getElementById('vikaStatus').className = 'status-value connected';
                    } else {
                        document.getElementById('vikaStatus').textContent = '未连接';
                        document.getElementById('vikaStatus').className = 'status-value disconnected';
                    }

                    const localCodes = this.getLocalActivationCodes();
                    const totalCodes = Object.keys(codes).length || Object.keys(localCodes).length;
                    const usedCodes = Object.values(codes).filter(code => code.isUsed).length ||
                                    Object.values(localCodes).filter(code => code.isUsed).length;

                    document.getElementById('localStatus').textContent = '正常';
                    document.getElementById('localStatus').className = 'status-value connected';
                    document.getElementById('totalCodes').textContent = totalCodes;
                    document.getElementById('usedCodes').textContent = usedCodes;

                } catch (error) {
                    document.getElementById('vikaStatus').textContent = '错误';
                    document.getElementById('vikaStatus').className = 'status-value disconnected';
                    document.getElementById('localStatus').textContent = '错误';
                    document.getElementById('localStatus').className = 'status-value disconnected';
                }
            }

            log(message, level = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = {
                    timestamp,
                    level,
                    message
                };

                this.logs.unshift(logEntry);

                // 限制日志数量
                if (this.logs.length > 1000) {
                    this.logs.splice(1000);
                }

                this.updateLogDisplay();
            }

            updateLogDisplay() {
                if (this.logsPaused) return;

                const container = document.getElementById('logContainer');
                container.innerHTML = '';

                this.logs.forEach(log => {
                    const entry = document.createElement('div');
                    entry.className = 'log-entry';

                    entry.innerHTML = `
                        <span class="log-timestamp">[${log.timestamp}]</span>
                        <span class="log-level">[${log.level.toUpperCase()}]</span>
                        <span class="log-message">${log.message}</span>
                    `;

                    container.appendChild(entry);
                });

                if (this.autoScroll) {
                    container.scrollTop = container.scrollHeight;
                }
            }

            clearLogs() {
                this.logs = [];
                this.updateLogDisplay();
                this.log('🧹 日志已清空', 'info');
            }

            toggleLogsPause() {
                this.logsPaused = !this.logsPaused;
                const btn = document.getElementById('pauseLogsBtn');
                btn.textContent = this.logsPaused ? '继续' : '暂停';

                if (!this.logsPaused) {
                    this.updateLogDisplay();
                }

                this.log(`日志${this.logsPaused ? '暂停' : '继续'}`, 'info');
            }

            toggleAutoScroll() {
                this.autoScroll = !this.autoScroll;
                const btn = document.getElementById('autoScrollBtn');
                btn.textContent = this.autoScroll ? '自动滚动' : '停止滚动';

                if (this.autoScroll) {
                    const container = document.getElementById('logContainer');
                    container.scrollTop = container.scrollHeight;
                }

                this.log(`自动滚动${this.autoScroll ? '开启' : '关闭'}`, 'info');
            }

            showInitializationSuccess() {
                const successDiv = document.getElementById('initializationSuccess');
                if (successDiv) {
                    successDiv.style.display = 'block';

                    // 3秒后自动隐藏
                    setTimeout(() => {
                        successDiv.style.display = 'none';
                    }, 3000);
                }
            }
        }

        // 页面加载完成后初始化测试系统
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🧪 维格表激活码测试页面加载完成');
            window.vikaTestSystem = new VikaTestSystem();
        });
    </script>
</body>
</html>
